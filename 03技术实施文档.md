# å·…å³°æ€ (PeakState) æŠ€æœ¯å®æ–½æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 2.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2025å¹´10æœˆ8æ—¥  
**ä½œè€…ï¼š** Manus AI  
**é€‚ç”¨å¯¹è±¡ï¼š** æŠ€æœ¯å›¢é˜Ÿã€AIç¼–ç¨‹å·¥å…·ï¼ˆClaude Codeã€Cursorã€Codexï¼‰

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#1-ç³»ç»Ÿæ¶æ„è®¾è®¡)
2. [æ•°æ®æµç¨‹è®¾è®¡](#2-æ•°æ®æµç¨‹è®¾è®¡)
3. [ç”¨æˆ·äº¤äº’æµç¨‹](#3-ç”¨æˆ·äº¤äº’æµç¨‹)
4. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡](#4-æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡)
5. [AIç¼–ç¨‹å·¥å…·å¼€å‘æç¤ºè¯](#5-aiç¼–ç¨‹å·¥å…·å¼€å‘æç¤ºè¯)
6. [éƒ¨ç½²ä¸è¿ç»´](#6-éƒ¨ç½²ä¸è¿ç»´)

---

## 1. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„å›¾

\`\`\`mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚ - Client Layer"
        A1[iOS App - Swift/SwiftUI]
        A2[Android App - æœªæ¥è§„åˆ’]
        A3[Web App - æœªæ¥è§„åˆ’]
    end
    
    subgraph "APIç½‘å…³å±‚ - API Gateway"
        B1[Nginx / ALB]
        B2[API Gateway]
        B3[è®¤è¯ä¸­é—´ä»¶]
    end
    
    subgraph "åº”ç”¨æœåŠ¡å±‚ - Application Layer"
        C1[ç”¨æˆ·æœåŠ¡<br/>User Service]
        C2[å¯¹è¯æœåŠ¡<br/>Chat Service]
        C3[æ•°æ®é‡‡é›†æœåŠ¡<br/>Data Collection]
        C4[åˆ†ææœåŠ¡<br/>Analytics Service]
        C5[æ¨é€æœåŠ¡<br/>Notification Service]
    end
    
    subgraph "AIæ™ºèƒ½å±‚ - AI Layer"
        D1[LLMæœåŠ¡<br/>GPT-4 API]
        D2[ç²¾åŠ›é¢„æµ‹æ¨¡å‹<br/>Energy Prediction]
        D3[æ¨èå¼•æ“<br/>Recommendation]
        D4[æƒ…æ„Ÿåˆ†æ<br/>Sentiment Analysis]
    end
    
    subgraph "æ•°æ®å±‚ - Data Layer"
        E1[(PostgreSQL<br/>ç”¨æˆ·æ•°æ®)]
        E2[(MongoDB<br/>å¯¹è¯å†å²)]
        E3[(Redis<br/>ç¼“å­˜)]
        E4[(æ—¶åºæ•°æ®åº“<br/>InfluxDB)]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡ - External Services"
        F1[Apple Health API]
        F2[Google Fit API]
        F3[æ—¥å†API]
        F4[å¤©æ°”API]
        F5[æ”¯ä»˜ç½‘å…³]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> C1
    B3 --> C2
    B3 --> C3
    B3 --> C4
    B3 --> C5
    
    C2 --> D1
    C4 --> D2
    C4 --> D3
    C2 --> D4
    
    C1 --> E1
    C2 --> E2
    C3 --> E4
    C4 --> E1
    C1 --> E3
    C2 --> E3
    
    C3 --> F1
    C3 --> F2
    C3 --> F3
    C3 --> F4
    C1 --> F5
\`\`\`

### 1.2 æŠ€æœ¯æ ˆè¯¦ç»†è¯´æ˜

| å±‚çº§ | ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç†ç”± |
|------|------|---------|------|
| **å‰ç«¯** | iOSåº”ç”¨ | Swift 5.9+ + SwiftUI | åŸç”Ÿå¼€å‘ï¼Œæœ€ä½³æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ |
| | æ¶æ„æ¨¡å¼ | MVVM + Combine | å“åº”å¼ç¼–ç¨‹ï¼Œæ•°æ®æµæ¸…æ™° |
| | ç½‘ç»œè¯·æ±‚ | URLSession + async/await | åŸç”Ÿå¼‚æ­¥ç½‘ç»œï¼Œæ€§èƒ½æœ€ä¼˜ |
| | æœ¬åœ°å­˜å‚¨ | SwiftData + Keychain | iOS 17+åŸç”ŸæŒä¹…åŒ–æ–¹æ¡ˆ |
| | æ•°æ®é‡‡é›† | HealthKit + EventKit | æ·±åº¦é›†æˆAppleç”Ÿæ€ |
| **åç«¯** | APIæ¡†æ¶ | FastAPI (Python) | é«˜æ€§èƒ½ï¼ŒåŸç”Ÿæ”¯æŒå¼‚æ­¥ï¼Œæ˜“äºé›†æˆAI |
| | è®¤è¯ | JWT + OAuth 2.0 | æ— çŠ¶æ€è®¤è¯ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹ç™»å½• |
| | ä»»åŠ¡é˜Ÿåˆ— | Celery + Redis | å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼ˆæ•°æ®åŒæ­¥ã€æ¨é€ç­‰ï¼‰ |
| **AI** | LLM | OpenAI GPT-4 API | æœ€å¼ºå¯¹è¯èƒ½åŠ› |
| | MLæ¡†æ¶ | scikit-learn + XGBoost | ä¼ ç»ŸMLæ¨¡å‹ |
| | DLæ¡†æ¶ | PyTorch | æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆåæœŸï¼‰ |
| **æ•°æ®åº“** | å…³ç³»å‹ | PostgreSQL | å¯é æ€§é«˜ï¼Œæ”¯æŒJSONå­—æ®µ |
| | æ–‡æ¡£å‹ | MongoDB | çµæ´»çš„å¯¹è¯å†å²å­˜å‚¨ |
| | ç¼“å­˜ | Redis | é«˜æ€§èƒ½ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ— |
| | æ—¶åº | InfluxDB | ä¸“ä¸ºæ—¶åºæ•°æ®ä¼˜åŒ– |
| **éƒ¨ç½²** | äº‘å¹³å° | é˜¿é‡Œäº‘ | ä¸­å›½å¤§é™†ç”¨æˆ·ï¼Œåˆè§„æ€§å¥½ |
| | å®¹å™¨åŒ– | Docker + Docker Compose | ç¯å¢ƒä¸€è‡´æ€§ |
| | ç¼–æ’ | Kubernetes (å¯é€‰) | åæœŸæ‰©å±• |
| | CI/CD | GitHub Actions | è‡ªåŠ¨åŒ–éƒ¨ç½² |

### 1.3 æ•°æ®åº“è®¾è®¡

#### 1.3.1 PostgreSQL æ ¸å¿ƒè¡¨ç»“æ„

\`\`\`sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    avatar_url VARCHAR(500),
    coach_type VARCHAR(50) DEFAULT 'balanced', -- æ•™ç»ƒé£æ ¼
    subscription_status VARCHAR(20) DEFAULT 'trial', -- trial, active, expired
    subscription_end_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·ç”»åƒè¡¨
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    age INTEGER,
    gender VARCHAR(10),
    occupation VARCHAR(100),
    goals JSONB, -- ["æå‡å·¥ä½œæ•ˆç‡", "æ”¹å–„ç¡çœ "]
    challenges JSONB, -- ["ç»å¸¸ç†¬å¤œ", "å‹åŠ›å¤§"]
    sleep_preference JSONB, -- {"target_hours": 8, "bedtime": "23:00"}
    work_schedule JSONB, -- {"work_days": [1,2,3,4,5], "work_hours": "9-18"}
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç²¾åŠ›è®°å½•è¡¨ (æ—¶åºæ•°æ®ï¼Œä¹Ÿä¼šåŒæ­¥åˆ°InfluxDB)
CREATE TABLE energy_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    timestamp TIMESTAMP NOT NULL,
    energy_level INTEGER CHECK (energy_level BETWEEN 1 AND 10),
    energy_source VARCHAR(20), -- 'predicted', 'user_reported', 'calculated'
    context JSONB, -- {"activity": "meeting", "location": "office"}
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_timestamp (user_id, timestamp DESC)
);

-- ç¡çœ æ•°æ®è¡¨
CREATE TABLE sleep_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    sleep_date DATE NOT NULL,
    bedtime TIMESTAMP,
    wake_time TIMESTAMP,
    duration_hours DECIMAL(4,2),
    quality_score INTEGER CHECK (quality_score BETWEEN 1 AND 10),
    deep_sleep_hours DECIMAL(4,2),
    rem_sleep_hours DECIMAL(4,2),
    data_source VARCHAR(50), -- 'apple_health', 'google_fit', 'manual'
    raw_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, sleep_date)
);

-- æ´»åŠ¨æ•°æ®è¡¨
CREATE TABLE activity_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    steps INTEGER,
    active_minutes INTEGER,
    calories_burned INTEGER,
    exercise_sessions JSONB, -- [{"type": "running", "duration": 30}]
    data_source VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, date)
);

-- å¹²é¢„è®°å½•è¡¨
CREATE TABLE interventions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    timestamp TIMESTAMP NOT NULL,
    intervention_type VARCHAR(50), -- 'breathing', 'meditation', 'exercise'
    duration_seconds INTEGER,
    completion_status VARCHAR(20), -- 'completed', 'partial', 'skipped'
    pre_energy_level INTEGER,
    post_energy_level INTEGER,
    user_feedback JSONB, -- {"helpful": true, "rating": 4}
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ¨èå†å²è¡¨
CREATE TABLE recommendation_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    timestamp TIMESTAMP NOT NULL,
    recommendation_type VARCHAR(50),
    recommendation_content JSONB,
    user_action VARCHAR(20), -- 'accepted', 'dismissed', 'ignored'
    effectiveness_score DECIMAL(3,2), -- 0-1, äº‹åè¯„ä¼°
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
\`\`\`

#### 1.3.2 MongoDB å¯¹è¯å†å²ç»“æ„

\`\`\`javascript
// conversations é›†åˆ
{
  "_id": ObjectId("..."),
  "user_id": "uuid",
  "conversation_id": "uuid",
  "started_at": ISODate("2025-10-08T08:00:00Z"),
  "last_message_at": ISODate("2025-10-08T08:15:00Z"),
  "conversation_type": "morning_briefing", // morning_briefing, evening_review, ad_hoc
  "messages": [
    {
      "role": "assistant",
      "content": "æ—©ä¸Šå¥½ï¼æˆ‘çœ‹åˆ°ä½ æ˜¨æ™šç¡äº†7.5å°æ—¶ï¼Œè´¨é‡ä¸é”™ã€‚ä»Šå¤©é¢„è®¡ç²¾åŠ›çŠ¶æ€è‰¯å¥½ã€‚",
      "timestamp": ISODate("2025-10-08T08:00:00Z"),
      "metadata": {
        "energy_prediction": 8,
        "sleep_analysis": {...}
      }
    },
    {
      "role": "user",
      "content": "ä½†æˆ‘è¿˜æ˜¯è§‰å¾—æœ‰ç‚¹ç´¯",
      "timestamp": ISODate("2025-10-08T08:01:00Z")
    },
    {
      "role": "assistant",
      "content": "æˆ‘ç†è§£ã€‚è™½ç„¶ç¡çœ æ—¶é•¿è¶³å¤Ÿï¼Œä½†å¯èƒ½ç¡çœ è´¨é‡è¿˜æœ‰æå‡ç©ºé—´ã€‚è¦ä¸è¦è¯•è¯•5åˆ†é’Ÿçš„å‘¼å¸ç»ƒä¹ ï¼Ÿ",
      "timestamp": ISODate("2025-10-08T08:01:30Z"),
      "metadata": {
        "intervention_suggested": "breathing",
        "reasoning": "ç”¨æˆ·ä¸»è§‚æ„Ÿå—ä¸é¢„æµ‹ä¸ç¬¦ï¼Œå»ºè®®å¿«é€Ÿå¹²é¢„"
      }
    }
  ],
  "summary": "ç”¨æˆ·ç¡çœ æ—¶é•¿è¶³å¤Ÿä½†ä¸»è§‚æ„Ÿå—ç–²åŠ³ï¼Œå»ºè®®å‘¼å¸ç»ƒä¹ ",
  "tags": ["sleep_quality", "fatigue", "breathing_exercise"]
}
\`\`\`

---

## 2. æ•°æ®æµç¨‹è®¾è®¡

### 2.1 æ•°æ®é‡‡é›†æµç¨‹

\`\`\`mermaid
sequenceDiagram
    participant U as ç”¨æˆ·è®¾å¤‡
    participant A as APP
    participant DC as æ•°æ®é‡‡é›†æœåŠ¡
    participant EXT as å¤–éƒ¨API
    participant DB as æ•°æ®åº“
    participant TS as æ—¶åºæ•°æ®åº“
    
    Note over U,TS: è¢«åŠ¨æ•°æ®é‡‡é›†ï¼ˆåå°è‡ªåŠ¨ï¼‰
    
    A->>DC: å®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆæ¯å°æ—¶ï¼‰
    DC->>EXT: è¯·æ±‚Apple Healthæ•°æ®
    EXT-->>DC: è¿”å›ç¡çœ ã€å¿ƒç‡ã€è¿åŠ¨æ•°æ®
    DC->>DC: æ•°æ®æ¸…æ´—å’ŒéªŒè¯
    DC->>DB: å­˜å‚¨åˆ°PostgreSQL
    DC->>TS: å­˜å‚¨åˆ°InfluxDBï¼ˆæ—¶åºï¼‰
    
    Note over U,TS: ä¸»åŠ¨æ•°æ®é‡‡é›†ï¼ˆç”¨æˆ·è§¦å‘ï¼‰
    
    U->>A: ç”¨æˆ·ä¸AIæ•™ç»ƒå¯¹è¯
    A->>DC: æäº¤å¯¹è¯å†…å®¹
    DC->>DC: æå–ä¸»è§‚æ•°æ®ï¼ˆç²¾åŠ›è¯„åˆ†ã€æƒ…ç»ªï¼‰
    DC->>DB: å­˜å‚¨ç²¾åŠ›è®°å½•
    DC->>TS: æ›´æ–°æ—¶åºæ•°æ®
\`\`\`

### 2.2 AIå¯¹è¯æµç¨‹

\`\`\`mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant APP as å‰ç«¯APP
    participant CS as å¯¹è¯æœåŠ¡
    participant AS as åˆ†ææœåŠ¡
    participant LLM as GPT-4 API
    participant DB as æ•°æ®åº“
    
    U->>APP: å‘é€æ¶ˆæ¯
    APP->>CS: POST /api/chat/message
    
    CS->>DB: è·å–ç”¨æˆ·ç”»åƒ
    CS->>DB: è·å–æœ€è¿‘ç²¾åŠ›æ•°æ®
    CS->>DB: è·å–å¯¹è¯å†å²
    
    CS->>AS: è¯·æ±‚å½“å‰ç²¾åŠ›è¯„ä¼°
    AS->>AS: è¿è¡Œé¢„æµ‹æ¨¡å‹
    AS-->>CS: è¿”å›ç²¾åŠ›è¯„ä¼°ç»“æœ
    
    CS->>CS: æ„å»ºä¸Šä¸‹æ–‡Prompt
    Note over CS: åŒ…å«ï¼šç”¨æˆ·ç”»åƒã€ç²¾åŠ›æ•°æ®ã€<br/>å¯¹è¯å†å²ã€å½“å‰è¯„ä¼°
    
    CS->>LLM: å‘é€Prompt
    LLM-->>CS: è¿”å›AIå›å¤
    
    CS->>DB: ä¿å­˜å¯¹è¯è®°å½•
    CS-->>APP: è¿”å›AIå›å¤
    APP-->>U: æ˜¾ç¤ºå›å¤
    
    opt å¦‚æœAIå»ºè®®å¹²é¢„
        CS->>CS: è®°å½•æ¨è
        CS->>APP: æ¨é€å¹²é¢„å»ºè®®
    end
\`\`\`

### 2.3 ç²¾åŠ›é¢„æµ‹æµç¨‹

\`\`\`mermaid
flowchart TD
    A[è§¦å‘é¢„æµ‹] --> B{ç”¨æˆ·æ•°æ®å……è¶³?}
    B -->|å¦| C[ä½¿ç”¨é€šç”¨æ¨¡å‹]
    B -->|æ˜¯| D[åŠ è½½ä¸ªæ€§åŒ–æ¨¡å‹]
    
    C --> E[æ”¶é›†ç‰¹å¾æ•°æ®]
    D --> E
    
    E --> F[ç‰¹å¾å·¥ç¨‹]
    F --> G[æ¨¡å‹æ¨ç†]
    
    G --> H{é¢„æµ‹ç²¾åŠ›æ°´å¹³}
    H --> I[é«˜ç²¾åŠ› 8-10]
    H --> J[ä¸­ç²¾åŠ› 5-7]
    H --> K[ä½ç²¾åŠ› 1-4]
    
    I --> L[ç”Ÿæˆå»ºè®®:<br/>ä¿æŒçŠ¶æ€]
    J --> M[ç”Ÿæˆå»ºè®®:<br/>é€‚åº¦å¹²é¢„]
    K --> N[ç”Ÿæˆå»ºè®®:<br/>ç«‹å³å¹²é¢„]
    
    L --> O[è¿”å›é¢„æµ‹ç»“æœ]
    M --> O
    N --> O
    
    O --> P[æ›´æ–°ç¼“å­˜]
    P --> Q[è®°å½•é¢„æµ‹å†å²]
\`\`\`

---

## 3. ç”¨æˆ·äº¤äº’æµç¨‹

### 3.1 ç”¨æˆ·æ—…ç¨‹åœ°å›¾

\`\`\`mermaid
journey
    title ç”¨æˆ·ä¸€å¤©çš„ç²¾åŠ›ç®¡ç†æ—…ç¨‹
    section æ—©æ™¨ (7:00-9:00)
      æ”¶åˆ°æ™¨é—´ç®€æŠ¥æ¨é€: 5: ç”¨æˆ·
      æ‰“å¼€APPæŸ¥çœ‹ç®€æŠ¥: 5: ç”¨æˆ·
      ä¸AIæ•™ç»ƒå¯¹è¯: 4: ç”¨æˆ·
      æˆæƒæ•°æ®åŒæ­¥: 3: ç”¨æˆ·
    section ä¸Šåˆ (9:00-12:00)
      ä¸“æ³¨å·¥ä½œ: 4: ç”¨æˆ·
      æ”¶åˆ°ç²¾åŠ›é¢„è­¦: 3: ç”¨æˆ·
      è¿›è¡Œå‘¼å¸ç»ƒä¹ : 4: ç”¨æˆ·
    section ä¸­åˆ (12:00-14:00)
      åˆé¤ä¼‘æ¯: 5: ç”¨æˆ·
      æŸ¥çœ‹ç²¾åŠ›ä»ªè¡¨ç›˜: 3: ç”¨æˆ·
    section ä¸‹åˆ (14:00-18:00)
      ç»§ç»­å·¥ä½œ: 3: ç”¨æˆ·
      æ”¶åˆ°ä¸“æ³¨æé†’: 4: ç”¨æˆ·
      ä½¿ç”¨ä¸“æ³¨è®¡æ—¶å™¨: 5: ç”¨æˆ·
    section æ™šä¸Š (18:00-22:00)
      ä¸‹ç­è¿åŠ¨: 5: ç”¨æˆ·
      æ”¶åˆ°æ™šé—´å¤ç›˜æ¨é€: 4: ç”¨æˆ·
      ä¸AIæ•™ç»ƒå¤ç›˜: 5: ç”¨æˆ·
      è®¾å®šæ˜æ—¥ç›®æ ‡: 4: ç”¨æˆ·
    section ç¡å‰ (22:00-23:00)
      æ”¶åˆ°ç¡çœ æé†’: 5: ç”¨æˆ·
      è¿›è¡Œå†¥æƒ³ç»ƒä¹ : 4: ç”¨æˆ·
      å…¥ç¡: 5: ç”¨æˆ·
\`\`\`

### 3.2 æ ¸å¿ƒäº¤äº’æµç¨‹

#### 3.2.1 é¦–æ¬¡ä½¿ç”¨æµç¨‹

\`\`\`mermaid
flowchart TD
    A[ä¸‹è½½APP] --> B[å¯åŠ¨APP]
    B --> C[æ¬¢è¿åŠ¨ç”»]
    C --> D[é€‰æ‹©æ•™ç»ƒå½¢è±¡]
    D --> E[AIæ•™ç»ƒè‡ªæˆ‘ä»‹ç»]
    
    E --> F[è¯·æ±‚æ•°æ®æˆæƒ]
    F --> G{ç”¨æˆ·æˆæƒ?}
    G -->|æ˜¯| H[è¿æ¥Apple Health/Google Fit]
    G -->|å¦| I[è¯´æ˜æ— ç¡¬ä»¶æ–¹æ¡ˆ]
    
    H --> J[åˆå§‹é—®å· 1/5:<br/>åŸºæœ¬ä¿¡æ¯]
    I --> J
    
    J --> K[åˆå§‹é—®å· 2/5:<br/>ç›®æ ‡è®¾å®š]
    K --> L[åˆå§‹é—®å· 3/5:<br/>å½“å‰æŒ‘æˆ˜]
    L --> M[åˆå§‹é—®å· 4/5:<br/>ç”Ÿæ´»ä¹ æƒ¯]
    M --> N[åˆå§‹é—®å· 5/5:<br/>å·¥ä½œæ¨¡å¼]
    
    N --> O[ç”Ÿæˆä¸ªæ€§åŒ–ç”»åƒ]
    O --> P[å±•ç¤ºè®¢é˜…é€‰é¡¹]
    P --> Q{é€‰æ‹©è®¢é˜…?}
    
    Q -->|7å¤©è¯•ç”¨| R[ç»‘å®šæ”¯ä»˜æ–¹å¼]
    Q -->|ç›´æ¥ä»˜è´¹| R
    Q -->|æš‚ä¸è®¢é˜…| S[è¿›å…¥å…è´¹æ¨¡å¼<br/>åŠŸèƒ½å—é™]
    
    R --> T[å®Œæˆå…¥èŒ]
    S --> T
    T --> U[è¿›å…¥ä¸»ç•Œé¢]
\`\`\`

#### 3.2.2 æ™¨é—´ç®€æŠ¥æµç¨‹

\`\`\`mermaid
sequenceDiagram
    participant S as ç³»ç»Ÿå®šæ—¶ä»»åŠ¡
    participant AS as åˆ†ææœåŠ¡
    participant CS as å¯¹è¯æœåŠ¡
    participant NS as æ¨é€æœåŠ¡
    participant U as ç”¨æˆ·
    
    Note over S: æ¯å¤©æ—©ä¸Š7:00è§¦å‘
    
    S->>AS: ç”Ÿæˆæ™¨é—´åˆ†æ
    AS->>AS: åˆ†ææ˜¨æ™šç¡çœ 
    AS->>AS: é¢„æµ‹ä»Šæ—¥ç²¾åŠ›
    AS->>AS: æ£€æŸ¥ä»Šæ—¥æ—¥ç¨‹
    AS-->>S: è¿”å›åˆ†æç»“æœ
    
    S->>CS: ç”Ÿæˆæ™¨é—´ç®€æŠ¥å†…å®¹
    CS->>CS: æ„å»ºä¸ªæ€§åŒ–ç®€æŠ¥
    CS-->>S: è¿”å›ç®€æŠ¥æ–‡æœ¬
    
    S->>NS: å‘é€æ¨é€é€šçŸ¥
    NS->>U: æ¨é€ï¼š"æ—©ä¸Šå¥½ï¼ä»Šå¤©çš„ç²¾åŠ›ç®€æŠ¥å·²å‡†å¤‡å¥½"
    
    U->>APP: ç‚¹å‡»æ¨é€æ‰“å¼€APP
    APP->>CS: è¯·æ±‚æ™¨é—´ç®€æŠ¥
    CS-->>APP: è¿”å›å®Œæ•´ç®€æŠ¥
    APP->>U: å±•ç¤ºç®€æŠ¥å†…å®¹
    
    opt ç”¨æˆ·ä¸AIäº’åŠ¨
        U->>APP: å‘é€é—®é¢˜
        APP->>CS: ç»§ç»­å¯¹è¯
        CS-->>APP: AIå›å¤
    end
\`\`\`

---

## 4. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡

### 4.1 ç”¨æˆ·è®¤è¯æ¨¡å—

**åŠŸèƒ½æè¿°ï¼š** å¤„ç†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€JWTè®¤è¯

**æŠ€æœ¯æ–¹æ¡ˆï¼š**
- JWT Tokenè®¤è¯
- Refresh Tokenæœºåˆ¶
- ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆAppleã€å¾®ä¿¡ï¼‰

**APIè®¾è®¡ï¼š**

\`\`\`python
# POST /api/auth/register
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "name": "å¼ ä¸‰"
}

# Response
{
  "user_id": "uuid",
  "access_token": "jwt_token",
  "refresh_token": "refresh_token",
  "expires_in": 3600
}

# POST /api/auth/login
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

# POST /api/auth/refresh
{
  "refresh_token": "refresh_token"
}
\`\`\`

### 4.2 æ•°æ®é‡‡é›†æ¨¡å—

**åŠŸèƒ½æè¿°ï¼š** ä»å¤šä¸ªæ•°æ®æºé‡‡é›†ç”¨æˆ·ç²¾åŠ›ç›¸å…³æ•°æ®

**æ•°æ®æºï¼š**
1. Apple Health / Google Fit
2. ç³»ç»Ÿæ—¥å†
3. ç”¨æˆ·å¯¹è¯ï¼ˆä¸»è§‚æ•°æ®ï¼‰
4. ç¬¬ä¸‰æ–¹APIï¼ˆå¤©æ°”ç­‰ï¼‰

**é‡‡é›†ç­–ç•¥ï¼š**
- åå°å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å°æ—¶ï¼‰
- ç”¨æˆ·è§¦å‘ï¼ˆæ‰“å¼€APPæ—¶ï¼‰
- å®æ—¶åŒæ­¥ï¼ˆå¯¹è¯ä¸­ï¼‰

**APIè®¾è®¡ï¼š**

\`\`\`python
# POST /api/data/sync/health
# åŒæ­¥å¥åº·æ•°æ®
{
  "data_source": "apple_health",
  "data_type": "sleep",
  "records": [
    {
      "date": "2025-10-07",
      "bedtime": "2025-10-07T23:00:00Z",
      "wake_time": "2025-10-08T07:00:00Z",
      "duration_hours": 8.0,
      "deep_sleep_hours": 2.5,
      "rem_sleep_hours": 1.5
    }
  ]
}

# POST /api/data/energy/report
# ç”¨æˆ·æ‰‹åŠ¨æŠ¥å‘Šç²¾åŠ›
{
  "energy_level": 7,
  "timestamp": "2025-10-08T10:00:00Z",
  "context": {
    "activity": "working",
    "mood": "focused"
  }
}
\`\`\`

### 4.3 AIå¯¹è¯æ¨¡å—

**åŠŸèƒ½æè¿°ï¼š** æä¾›æ™ºèƒ½å¯¹è¯èƒ½åŠ›ï¼Œæ¨¡æ‹ŸçœŸäººæ•™ç»ƒ

**æ ¸å¿ƒç»„ä»¶ï¼š**
1. ä¸Šä¸‹æ–‡ç®¡ç†å™¨
2. Promptæ„å»ºå™¨
3. LLMæ¥å£å°è£…
4. å¯¹è¯å†å²ç®¡ç†

**Promptæ¨¡æ¿ï¼š**

\`\`\`python
COACH_SYSTEM_PROMPT = """
ä½ æ˜¯{user_name}çš„ç§äººç²¾åŠ›ç®¡ç†æ•™ç»ƒï¼Œåå­—å«"å°å³°"ã€‚

## ä½ çš„è§’è‰²å®šä½
- ä¸“ä¸šï¼šä½ æ‹¥æœ‰ç²¾åŠ›ç®¡ç†ã€ç¡çœ ç§‘å­¦ã€è¿åŠ¨è¥å…»ç­‰é¢†åŸŸçš„ä¸“ä¸šçŸ¥è¯†
- å…±æƒ…ï¼šä½ èƒ½ç†è§£ç”¨æˆ·çš„å›°éš¾å’ŒæŒ‘æˆ˜ï¼Œç»™äºˆæƒ…æ„Ÿæ”¯æŒ
- è¡ŒåŠ¨å¯¼å‘ï¼šä½ çš„å»ºè®®éƒ½æ˜¯å…·ä½“çš„ã€å¯æ‰§è¡Œçš„
- ä¸ªæ€§åŒ–ï¼šä½ äº†è§£ç”¨æˆ·çš„èƒŒæ™¯ã€ç›®æ ‡å’Œä¹ æƒ¯

## ç”¨æˆ·ç”»åƒ
- å§“åï¼š{user_name}
- å¹´é¾„ï¼š{age}å²
- èŒä¸šï¼š{occupation}
- ç›®æ ‡ï¼š{goals}
- æŒ‘æˆ˜ï¼š{challenges}

## å½“å‰æ•°æ®
- æ˜¨æ™šç¡çœ ï¼š{sleep_last_night}å°æ—¶ï¼ˆè´¨é‡è¯„åˆ†ï¼š{sleep_quality}/10ï¼‰
- å½“å‰ç²¾åŠ›é¢„æµ‹ï¼š{current_energy}/10
- ä»Šæ—¥ç²¾åŠ›è¶‹åŠ¿ï¼š{energy_trend}
- ä»Šæ—¥é‡è¦äº‹é¡¹ï¼š{today_schedule}

## å¯¹è¯å†å²
{conversation_history}

## ä½ çš„å›å¤è¦æ±‚
1. è¯­æ°”ï¼šæ¸©å’Œã€ä¸“ä¸šã€é¼“åŠ±
2. é•¿åº¦ï¼šç®€æ´æ˜äº†ï¼Œä¸€èˆ¬2-3å¥è¯
3. ç»“æ„ï¼šå…ˆå…±æƒ…ï¼Œå†åˆ†æï¼Œåå»ºè®®
4. å¯æ“ä½œæ€§ï¼šç»™å‡ºå…·ä½“çš„è¡ŒåŠ¨å»ºè®®

ç”¨æˆ·åˆšåˆšè¯´ï¼š"{user_message}"

è¯·å›å¤ï¼š
"""
\`\`\`

**APIè®¾è®¡ï¼š**

\`\`\`python
# POST /api/chat/message
{
  "message": "æˆ‘ä»Šå¤©æ„Ÿè§‰å¾ˆç´¯",
  "conversation_id": "uuid",  # å¯é€‰ï¼Œæ–°å¯¹è¯åˆ™ä¸ä¼ 
  "context": {
    "trigger": "user_initiated"  # user_initiated, morning_briefing, intervention
  }
}

# Response
{
  "conversation_id": "uuid",
  "message_id": "uuid",
  "response": "æˆ‘æ³¨æ„åˆ°ä½ æ˜¨æ™šåªç¡äº†5.5å°æ—¶ï¼Œè¿™å¯èƒ½æ˜¯ä½ æ„Ÿåˆ°ç–²åŠ³çš„ä¸»è¦åŸå› ã€‚ä¸‹åˆæœ‰ä¸ªé‡è¦ä¼šè®®ï¼Œè¦ä¸è¦ç°åœ¨åšä¸ª5åˆ†é’Ÿçš„å‘¼å¸ç»ƒä¹ ï¼Œå¸®ä½ æ¢å¤ä¸€ä¸‹ç²¾åŠ›ï¼Ÿ",
  "metadata": {
    "energy_assessment": 4,
    "intervention_suggested": {
      "type": "breathing",
      "duration": 300,
      "reason": "ä½ç²¾åŠ›çŠ¶æ€ï¼Œå³å°†æœ‰é‡è¦ä»»åŠ¡"
    }
  },
  "timestamp": "2025-10-08T10:05:00Z"
}
\`\`\`

### 4.4 ç²¾åŠ›é¢„æµ‹æ¨¡å—

**åŠŸèƒ½æè¿°ï¼š** åŸºäºå†å²æ•°æ®é¢„æµ‹ç”¨æˆ·æœªæ¥çš„ç²¾åŠ›çŠ¶æ€

**æ¨¡å‹æ¶æ„ï¼ˆMVPé˜¶æ®µï¼‰ï¼š**

\`\`\`python
class EnergyPredictionModel:
    """
    ç²¾åŠ›é¢„æµ‹æ¨¡å‹ï¼ˆMVPç‰ˆæœ¬ï¼šåŸºäºè§„åˆ™ï¼‰
    """
    
    def predict(self, user_data: dict) -> dict:
        """
        é¢„æµ‹ç”¨æˆ·å½“å‰å’Œæœªæ¥çš„ç²¾åŠ›æ°´å¹³
        
        Args:
            user_data: {
                'sleep_last_night': 7.5,
                'sleep_quality': 8,
                'recent_activity': 5000,  # æ­¥æ•°
                'time_of_day': '10:00',
                'day_of_week': 2,  # å‘¨äºŒ
                'upcoming_tasks': ['é‡è¦ä¼šè®®', 'é¡¹ç›®æ±‡æŠ¥']
            }
        
        Returns:
            {
                'current_energy': 7,
                'confidence': 0.85,
                'hourly_prediction': [
                    {'hour': 10, 'energy': 7},
                    {'hour': 11, 'energy': 6},
                    {'hour': 12, 'energy': 5},
                    ...
                ],
                'factors': {
                    'sleep': 0.3,  # è´¡çŒ®åº¦
                    'time': 0.2,
                    'activity': 0.1
                }
            }
        """
        # åŸºç¡€ç²¾åŠ›åˆ†æ•°ï¼ˆåŸºäºç¡çœ ï¼‰
        base_energy = self._calculate_sleep_energy(
            user_data['sleep_last_night'],
            user_data['sleep_quality']
        )
        
        # æ—¶é—´è°ƒæ•´ï¼ˆç”Ÿç†èŠ‚å¾‹ï¼‰
        time_adjustment = self._calculate_circadian_adjustment(
            user_data['time_of_day']
        )
        
        # æ´»åŠ¨è°ƒæ•´
        activity_adjustment = self._calculate_activity_adjustment(
            user_data['recent_activity']
        )
        
        # ç»¼åˆè®¡ç®—
        current_energy = min(10, max(1, 
            base_energy + time_adjustment + activity_adjustment
        ))
        
        # é¢„æµ‹æœªæ¥24å°æ—¶
        hourly_prediction = self._predict_hourly(
            current_energy,
            user_data
        )
        
        return {
            'current_energy': round(current_energy, 1),
            'confidence': 0.85,
            'hourly_prediction': hourly_prediction,
            'factors': {
                'sleep': 0.4,
                'circadian': 0.3,
                'activity': 0.2,
                'other': 0.1
            }
        }
    
    def _calculate_sleep_energy(self, hours: float, quality: int) -> float:
        """åŸºäºç¡çœ è®¡ç®—åŸºç¡€ç²¾åŠ›"""
        # æœ€ä¼˜ç¡çœ æ—¶é•¿ï¼š7-9å°æ—¶
        if 7 <= hours <= 9:
            sleep_score = 8
        elif 6 <= hours < 7:
            sleep_score = 6
        elif 5 <= hours < 6:
            sleep_score = 4
        else:
            sleep_score = 2
        
        # è´¨é‡è°ƒæ•´
        quality_factor = quality / 10
        return sleep_score * quality_factor
    
    def _calculate_circadian_adjustment(self, time_str: str) -> float:
        """åŸºäºç”Ÿç†èŠ‚å¾‹è°ƒæ•´"""
        hour = int(time_str.split(':')[0])
        
        # ç®€åŒ–çš„ç”Ÿç†èŠ‚å¾‹æ›²çº¿
        circadian_curve = {
            6: 0, 7: 1, 8: 2, 9: 2, 10: 2,
            11: 1, 12: 0, 13: -1, 14: -2, 15: -1,
            16: 0, 17: 1, 18: 1, 19: 0, 20: -1,
            21: -2, 22: -2, 23: -3, 0: -3, 1: -3
        }
        
        return circadian_curve.get(hour, 0)
    
    def _calculate_activity_adjustment(self, steps: int) -> float:
        """åŸºäºæ´»åŠ¨é‡è°ƒæ•´"""
        if steps > 8000:
            return 1
        elif steps > 5000:
            return 0.5
        else:
            return 0
    
    def _predict_hourly(self, current_energy: float, user_data: dict) -> list:
        """é¢„æµ‹æœªæ¥24å°æ—¶çš„ç²¾åŠ›"""
        predictions = []
        current_hour = int(user_data['time_of_day'].split(':')[0])
        
        for i in range(24):
            hour = (current_hour + i) % 24
            # ç®€åŒ–é¢„æµ‹ï¼šåŸºäºç”Ÿç†èŠ‚å¾‹è°ƒæ•´
            adjustment = self._calculate_circadian_adjustment(f"{hour}:00")
            predicted_energy = max(1, min(10, current_energy + adjustment))
            
            predictions.append({
                'hour': hour,
                'energy': round(predicted_energy, 1)
            })
        
        return predictions
\`\`\`

**APIè®¾è®¡ï¼š**

\`\`\`python
# GET /api/energy/predict
# Response
{
  "user_id": "uuid",
  "timestamp": "2025-10-08T10:00:00Z",
  "current_energy": 7.2,
  "confidence": 0.85,
  "hourly_prediction": [
    {"hour": 10, "energy": 7.2},
    {"hour": 11, "energy": 6.8},
    {"hour": 12, "energy": 6.0},
    {"hour": 13, "energy": 5.5},
    {"hour": 14, "energy": 5.0},
    {"hour": 15, "energy": 5.5},
    {"hour": 16, "energy": 6.5},
    ...
  ],
  "factors": {
    "sleep": {"contribution": 0.4, "value": 7.5},
    "circadian": {"contribution": 0.3, "value": "peak"},
    "activity": {"contribution": 0.2, "value": "moderate"}
  },
  "recommendations": [
    {
      "time": "14:00",
      "type": "warning",
      "message": "é¢„è®¡ä¸‹åˆ2ç‚¹ç²¾åŠ›æœ€ä½ï¼Œå»ºè®®æå‰ä¼‘æ¯"
    }
  ]
}
\`\`\`

### 4.5 æ¨èå¼•æ“æ¨¡å—

**åŠŸèƒ½æè¿°ï¼š** åŸºäºç”¨æˆ·çŠ¶æ€æ¨èåˆé€‚çš„å¹²é¢„æªæ–½

**æ¨èé€»è¾‘ï¼š**

\`\`\`python
class RecommendationEngine:
    """
    å¹²é¢„æ¨èå¼•æ“
    """
    
    def recommend(self, user_state: dict) -> dict:
        """
        æ¨èå¹²é¢„æªæ–½
        
        Args:
            user_state: {
                'current_energy': 4,
                'predicted_energy': 3,
                'upcoming_tasks': [
                    {'time': '14:00', 'importance': 'high', 'name': 'é‡è¦ä¼šè®®'}
                ],
                'available_time': 15,  # åˆ†é’Ÿ
                'location': 'office',
                'recent_interventions': ['breathing_10min_ago']
            }
        
        Returns:
            {
                'recommendation': {
                    'type': 'breathing',
                    'duration': 300,
                    'urgency': 'high',
                    'reason': '...'
                },
                'alternatives': [...]
            }
        """
        current_energy = user_state['current_energy']
        predicted_energy = user_state['predicted_energy']
        upcoming_tasks = user_state['upcoming_tasks']
        available_time = user_state['available_time']
        
        # è®¡ç®—ç²¾åŠ›ç¼ºå£
        energy_gap = self._calculate_energy_gap(
            current_energy,
            predicted_energy,
            upcoming_tasks
        )
        
        # é€‰æ‹©å¹²é¢„ç±»å‹
        if energy_gap > 3:  # ä¸¥é‡ä¸è¶³
            if available_time >= 20:
                return self._recommend_power_nap()
            elif available_time >= 10:
                return self._recommend_breathing()
            else:
                return self._recommend_quick_boost()
        
        elif energy_gap > 1:  # è½»åº¦ä¸è¶³
            if available_time >= 15:
                return self._recommend_meditation()
            else:
                return self._recommend_breathing()
        
        else:  # ç²¾åŠ›å……è¶³
            return self._recommend_maintenance()
    
    def _calculate_energy_gap(self, current, predicted, tasks):
        """è®¡ç®—ç²¾åŠ›ç¼ºå£"""
        if not tasks:
            return 0
        
        # æ‰¾åˆ°æœ€é‡è¦ä»»åŠ¡çš„æ‰€éœ€ç²¾åŠ›
        max_required = max([
            8 if t['importance'] == 'high' else 6
            for t in tasks
        ])
        
        return max(0, max_required - min(current, predicted))
    
    def _recommend_power_nap(self):
        return {
            'recommendation': {
                'type': 'power_nap',
                'duration': 1200,  # 20åˆ†é’Ÿ
                'urgency': 'high',
                'reason': 'ç²¾åŠ›ä¸¥é‡ä¸è¶³ï¼Œ20åˆ†é’Ÿå°ç¡èƒ½å¿«é€Ÿæ¢å¤',
                'expected_benefit': '+3 ç²¾åŠ›å€¼',
                'instructions': [
                    'æ‰¾ä¸€ä¸ªå®‰é™çš„åœ°æ–¹',
                    'è®¾ç½®20åˆ†é’Ÿé—¹é’Ÿ',
                    'é—­çœ¼æ”¾æ¾ï¼Œä¸è¦å¼ºè¿«å…¥ç¡',
                    'é†’æ¥åæ…¢æ…¢èµ·èº«'
                ]
            },
            'alternatives': [
                {
                    'type': 'breathing',
                    'duration': 600,
                    'reason': 'å¦‚æœæ— æ³•å°ç¡ï¼Œæ·±å‘¼å¸ä¹Ÿèƒ½å¸®åŠ©æ¢å¤'
                }
            ]
        }
    
    def _recommend_breathing(self):
        return {
            'recommendation': {
                'type': 'breathing',
                'duration': 300,  # 5åˆ†é’Ÿ
                'urgency': 'medium',
                'reason': 'é€šè¿‡å‘¼å¸ç»ƒä¹ å¿«é€Ÿè°ƒæ•´çŠ¶æ€',
                'expected_benefit': '+1 ç²¾åŠ›å€¼',
                'instructions': [
                    'æ‰¾ä¸€ä¸ªèˆ’é€‚çš„åå§¿',
                    'è·ŸéšAPPçš„å‘¼å¸å¼•å¯¼',
                    'å¸æ°”4ç§’ï¼Œå±æ¯4ç§’ï¼Œå‘¼æ°”4ç§’',
                    'é‡å¤5åˆ†é’Ÿ'
                ]
            },
            'alternatives': []
        }
    
    def _recommend_quick_boost(self):
        return {
            'recommendation': {
                'type': 'quick_boost',
                'duration': 180,  # 3åˆ†é’Ÿ
                'urgency': 'high',
                'reason': 'æ—¶é—´ç´§è¿«ï¼Œå¿«é€Ÿæå‡ç²¾åŠ›',
                'expected_benefit': '+0.5 ç²¾åŠ›å€¼',
                'instructions': [
                    'ç«™èµ·æ¥èµ°åŠ¨',
                    'å–ä¸€æ¯å†·æ°´',
                    'æ´—æŠŠå†·æ°´è„¸',
                    'åš10ä¸ªæ·±è¹²'
                ]
            },
            'alternatives': []
        }
\`\`\`

**APIè®¾è®¡ï¼š**

\`\`\`python
# GET /api/recommendations/current
# Response
{
  "timestamp": "2025-10-08T13:45:00Z",
  "recommendation": {
    "id": "uuid",
    "type": "breathing",
    "duration": 300,
    "urgency": "medium",
    "reason": "é¢„è®¡ä¸‹åˆ2ç‚¹ç²¾åŠ›ä¸‹é™ï¼Œæå‰è°ƒæ•´çŠ¶æ€",
    "expected_benefit": "+1 ç²¾åŠ›å€¼",
    "instructions": [
      "æ‰¾ä¸€ä¸ªèˆ’é€‚çš„åå§¿",
      "è·ŸéšAPPçš„å‘¼å¸å¼•å¯¼",
      "å¸æ°”4ç§’ï¼Œå±æ¯4ç§’ï¼Œå‘¼æ°”4ç§’",
      "é‡å¤5åˆ†é’Ÿ"
    ],
    "action_button": {
      "text": "å¼€å§‹å‘¼å¸ç»ƒä¹ ",
      "action": "start_breathing"
    }
  },
  "alternatives": [
    {
      "type": "meditation",
      "duration": 600,
      "reason": "å¦‚æœæœ‰æ›´å¤šæ—¶é—´ï¼Œå†¥æƒ³æ•ˆæœæ›´å¥½"
    }
  ]
}

# POST /api/recommendations/{id}/feedback
{
  "action": "accepted",  # accepted, dismissed, completed
  "effectiveness": 4,  # 1-5
  "comment": "å¾ˆæœ‰å¸®åŠ©"
}
\`\`\`

### 4.6 å¹²é¢„å·¥å…·æ¨¡å—

#### 4.6.1 å‘¼å¸ç»ƒä¹ 

**åŠŸèƒ½æè¿°ï¼š** å¼•å¯¼å¼å‘¼å¸ç»ƒä¹ ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿè°ƒæ•´çŠ¶æ€

**æŠ€æœ¯å®ç°ï¼š**
- åŠ¨ç”»ï¼šæ”¶ç¼©/èˆ’å¼ çš„åœ†åœˆ
- éŸ³æ•ˆï¼šå¯é€‰çš„èƒŒæ™¯éŸ³ä¹
- è®¡æ—¶ï¼šç²¾ç¡®çš„å‘¼å¸èŠ‚å¥æ§åˆ¶

**å‰ç«¯ç»„ä»¶è®¾è®¡ï¼š**

\`\`\`javascript
// BreathingExercise.js
import React, { useState, useEffect } from 'react';
import { View, Animated, Text } from 'react-native';

const BreathingExercise = ({ duration = 300 }) => {
  const [phase, setPhase] = useState('inhale'); // inhale, hold, exhale
  const [remainingTime, setRemainingTime] = useState(duration);
  const scaleValue = new Animated.Value(1);
  
  useEffect(() => {
    // å‘¼å¸åŠ¨ç”»å¾ªç¯
    const breathingCycle = () => {
      // å¸æ°” (4ç§’)
      Animated.timing(scaleValue, {
        toValue: 1.5,
        duration: 4000,
        useNativeDriver: true
      }).start(() => {
        setPhase('hold');
        // å±æ¯ (4ç§’)
        setTimeout(() => {
          setPhase('exhale');
          // å‘¼æ°” (4ç§’)
          Animated.timing(scaleValue, {
            toValue: 1,
            duration: 4000,
            useNativeDriver: true
          }).start(() => {
            setPhase('inhale');
            breathingCycle(); // ç»§ç»­å¾ªç¯
          });
        }, 4000);
      });
    };
    
    breathingCycle();
    
    // å€’è®¡æ—¶
    const timer = setInterval(() => {
      setRemainingTime(prev => {
        if (prev <= 1) {
          clearInterval(timer);
          onComplete();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);
    
    return () => clearInterval(timer);
  }, []);
  
  const getInstructionText = () => {
    switch(phase) {
      case 'inhale': return 'æ…¢æ…¢å¸æ°”...';
      case 'hold': return 'å±ä½å‘¼å¸...';
      case 'exhale': return 'ç¼“ç¼“å‘¼æ°”...';
    }
  };
  
  return (
    <View style={styles.container}>
      <Animated.View 
        style={[
          styles.circle,
          { transform: [{ scale: scaleValue }] }
        ]}
      />
      <Text style={styles.instruction}>{getInstructionText()}</Text>
      <Text style={styles.timer}>
        {Math.floor(remainingTime / 60)}:{(remainingTime % 60).toString().padStart(2, '0')}
      </Text>
    </View>
  );
};
\`\`\`

#### 4.6.2 ä¸“æ³¨è®¡æ—¶å™¨

**åŠŸèƒ½æè¿°ï¼š** å¸®åŠ©ç”¨æˆ·ä¸“æ³¨å·¥ä½œï¼Œè®°å½•ä¸“æ³¨æ—¶é•¿

**æŠ€æœ¯å®ç°ï¼š**
- PomodoroæŠ€æœ¯ï¼ˆ25åˆ†é’Ÿå·¥ä½œ + 5åˆ†é’Ÿä¼‘æ¯ï¼‰
- åå°è®¡æ—¶ï¼ˆå³ä½¿APPåœ¨åå°ä¹Ÿç»§ç»­è®¡æ—¶ï¼‰
- å®Œæˆæé†’

**APIè®¾è®¡ï¼š**

\`\`\`python
# POST /api/tools/focus/start
{
  "duration": 1500,  # 25åˆ†é’Ÿ
  "task_name": "å®Œæˆé¡¹ç›®æŠ¥å‘Š"
}

# Response
{
  "session_id": "uuid",
  "start_time": "2025-10-08T14:00:00Z",
  "end_time": "2025-10-08T14:25:00Z"
}

# POST /api/tools/focus/{session_id}/complete
{
  "actual_duration": 1500,
  "interruptions": 2,
  "completion_status": "completed"  # completed, partial, abandoned
}
\`\`\`

---

## 5. AIç¼–ç¨‹å·¥å…·å¼€å‘æç¤ºè¯

ä»¥ä¸‹æ˜¯å¯ä»¥ç›´æ¥å–‚ç»™Claude Codeã€Cursorã€Codexç­‰AIç¼–ç¨‹å·¥å…·çš„è¯¦ç»†æç¤ºè¯ã€‚

### 5.1 åç«¯ - ç”¨æˆ·è®¤è¯æœåŠ¡

\`\`\`
# å¼€å‘æç¤ºè¯ï¼šç”¨æˆ·è®¤è¯æœåŠ¡

## ä»»åŠ¡æè¿°
ä½¿ç”¨Python FastAPIæ¡†æ¶ï¼Œå¼€å‘ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·è®¤è¯æœåŠ¡ï¼ŒåŒ…æ‹¬æ³¨å†Œã€ç™»å½•ã€JWTè®¤è¯ã€Tokenåˆ·æ–°ç­‰åŠŸèƒ½ã€‚

## æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼šFastAPI
- æ•°æ®åº“ï¼šPostgreSQL (ä½¿ç”¨SQLAlchemy ORM)
- è®¤è¯ï¼šJWT (ä½¿ç”¨python-joseåº“)
- å¯†ç åŠ å¯†ï¼šbcrypt

## éœ€æ±‚è¯¦ç»†è¯´æ˜

### 1. é¡¹ç›®ç»“æ„
\`\`\`
app/
â”œâ”€â”€ main.py                 # FastAPIåº”ç”¨å…¥å£
â”œâ”€â”€ config.py               # é…ç½®æ–‡ä»¶
â”œâ”€â”€ models/
â”‚   â””â”€â”€ user.py            # ç”¨æˆ·æ¨¡å‹
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ auth.py            # Pydanticæ¨¡å¼
â”œâ”€â”€ services/
â”‚   â””â”€â”€ auth_service.py    # è®¤è¯ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ routers/
â”‚   â””â”€â”€ auth.py            # è®¤è¯è·¯ç”±
â””â”€â”€ utils/
    â”œâ”€â”€ security.py        # å®‰å…¨å·¥å…·å‡½æ•°
    â””â”€â”€ database.py        # æ•°æ®åº“è¿æ¥
\`\`\`

### 2. æ•°æ®åº“æ¨¡å‹ (models/user.py)
åˆ›å»ºUseræ¨¡å‹ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- id: UUIDä¸»é”®
- email: å”¯ä¸€é‚®ç®±
- password_hash: åŠ å¯†åçš„å¯†ç 
- name: ç”¨æˆ·å§“å
- avatar_url: å¤´åƒURL
- subscription_status: è®¢é˜…çŠ¶æ€ (trial, active, expired)
- subscription_end_date: è®¢é˜…ç»“æŸæ—¥æœŸ
- created_at, updated_at: æ—¶é—´æˆ³

### 3. APIç«¯ç‚¹

#### POST /api/auth/register
- è¾“å…¥ï¼šemail, password, name
- éªŒè¯ï¼š
  - é‚®ç®±æ ¼å¼æ­£ç¡®
  - å¯†ç å¼ºåº¦ï¼ˆè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼‰
  - é‚®ç®±æœªè¢«æ³¨å†Œ
- è¾“å‡ºï¼šuser_id, access_token, refresh_token

#### POST /api/auth/login
- è¾“å…¥ï¼šemail, password
- éªŒè¯ï¼šç”¨æˆ·å­˜åœ¨ä¸”å¯†ç æ­£ç¡®
- è¾“å‡ºï¼šuser_id, access_token, refresh_token

#### POST /api/auth/refresh
- è¾“å…¥ï¼šrefresh_token
- éªŒè¯ï¼šrefresh_tokenæœ‰æ•ˆ
- è¾“å‡ºï¼šæ–°çš„access_token

#### GET /api/auth/me
- éœ€è¦è®¤è¯
- è¾“å‡ºï¼šå½“å‰ç”¨æˆ·ä¿¡æ¯

### 4. JWTé…ç½®
- Access Tokenè¿‡æœŸæ—¶é—´ï¼š1å°æ—¶
- Refresh Tokenè¿‡æœŸæ—¶é—´ï¼š30å¤©
- ç®—æ³•ï¼šHS256
- Secret Keyï¼šä»ç¯å¢ƒå˜é‡è¯»å–

### 5. å®‰å…¨è¦æ±‚
- å¯†ç ä½¿ç”¨bcryptåŠ å¯†ï¼Œcost factor = 12
- JWT Secretä»ç¯å¢ƒå˜é‡è¯»å–
- æ‰€æœ‰å¯†ç ç›¸å…³çš„é”™è¯¯ä¿¡æ¯è¦æ¨¡ç³ŠåŒ–ï¼Œä¸è¦æš´éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨
- å®ç°è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰

### 6. é”™è¯¯å¤„ç†
- ä½¿ç”¨FastAPIçš„HTTPException
- è¿”å›æ ‡å‡†çš„é”™è¯¯æ ¼å¼ï¼š
  \`\`\`json
  {
    "error": {
      "code": "INVALID_CREDENTIALS",
      "message": "é‚®ç®±æˆ–å¯†ç é”™è¯¯"
    }
  }
  \`\`\`

### 7. æµ‹è¯•è¦æ±‚
- ä¸ºæ¯ä¸ªAPIç«¯ç‚¹ç¼–å†™å•å…ƒæµ‹è¯•
- æµ‹è¯•æˆåŠŸå’Œå¤±è´¥åœºæ™¯
- æµ‹è¯•è¾¹ç•Œæ¡ä»¶

## å¼€å§‹å¼€å‘
è¯·æŒ‰ç…§ä»¥ä¸Šéœ€æ±‚ï¼Œå®Œæ•´å®ç°ç”¨æˆ·è®¤è¯æœåŠ¡ã€‚ä»£ç è¦æ¸…æ™°ã€æœ‰æ³¨é‡Šã€ç¬¦åˆPEP 8è§„èŒƒã€‚
\`\`\`

### 5.2 åç«¯ - æ•°æ®é‡‡é›†æœåŠ¡

\`\`\`
# å¼€å‘æç¤ºè¯ï¼šæ•°æ®é‡‡é›†æœåŠ¡

## ä»»åŠ¡æè¿°
å¼€å‘ä¸€ä¸ªæ•°æ®é‡‡é›†æœåŠ¡ï¼Œè´Ÿè´£ä»å¤šä¸ªæ•°æ®æºï¼ˆApple Healthã€Google Fitã€ç”¨æˆ·è¾“å…¥ç­‰ï¼‰é‡‡é›†ç”¨æˆ·çš„ç²¾åŠ›ç›¸å…³æ•°æ®ï¼Œå¹¶å­˜å‚¨åˆ°æ•°æ®åº“ã€‚

## æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼šFastAPI
- æ•°æ®åº“ï¼šPostgreSQL + InfluxDB (æ—¶åºæ•°æ®)
- ä»»åŠ¡é˜Ÿåˆ—ï¼šCelery + Redis
- HTTPå®¢æˆ·ç«¯ï¼šhttpx (å¼‚æ­¥)

## éœ€æ±‚è¯¦ç»†è¯´æ˜

### 1. é¡¹ç›®ç»“æ„
\`\`\`
app/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ data_collection/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ health_sync.py      # å¥åº·æ•°æ®åŒæ­¥
â”‚       â”œâ”€â”€ calendar_sync.py    # æ—¥å†åŒæ­¥
â”‚       â”œâ”€â”€ weather_sync.py     # å¤©æ°”æ•°æ®
â”‚       â””â”€â”€ manual_input.py     # æ‰‹åŠ¨è¾“å…¥å¤„ç†
â”œâ”€â”€ tasks/
â”‚   â””â”€â”€ sync_tasks.py           # Celeryå¼‚æ­¥ä»»åŠ¡
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ sleep_record.py
â”‚   â”œâ”€â”€ activity_record.py
â”‚   â””â”€â”€ energy_record.py
â””â”€â”€ routers/
    â””â”€â”€ data.py                 # æ•°æ®ç›¸å…³API
\`\`\`

### 2. æ ¸å¿ƒåŠŸèƒ½

#### 2.1 å¥åº·æ•°æ®åŒæ­¥ (health_sync.py)
å®ç°ä¸€ä¸ªé€šç”¨çš„å¥åº·æ•°æ®åŒæ­¥ç±»ï¼š

\`\`\`python
class HealthDataSync:
    def __init__(self, user_id: str, data_source: str):
        self.user_id = user_id
        self.data_source = data_source  # 'apple_health' or 'google_fit'
    
    async def sync_sleep_data(self, start_date: date, end_date: date):
        """åŒæ­¥ç¡çœ æ•°æ®"""
        pass
    
    async def sync_activity_data(self, start_date: date, end_date: date):
        """åŒæ­¥æ´»åŠ¨æ•°æ®"""
        pass
    
    async def sync_heart_rate(self, start_date: date, end_date: date):
        """åŒæ­¥å¿ƒç‡æ•°æ®"""
        pass
\`\`\`

è¦æ±‚ï¼š
- æ”¯æŒå¢é‡åŒæ­¥ï¼ˆåªåŒæ­¥æ–°æ•°æ®ï¼‰
- å¤„ç†æ•°æ®å†²çªï¼ˆç›¸åŒæ—¥æœŸçš„æ•°æ®å¦‚ä½•å¤„ç†ï¼‰
- æ•°æ®éªŒè¯å’Œæ¸…æ´—
- å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶

#### 2.2 æ•°æ®å­˜å‚¨ç­–ç•¥
- ç»“æ„åŒ–æ•°æ®ï¼ˆç¡çœ ã€æ´»åŠ¨ï¼‰å­˜å‚¨åˆ°PostgreSQL
- æ—¶åºæ•°æ®ï¼ˆå¿ƒç‡ã€ç²¾åŠ›å€¼ï¼‰åŒæ—¶å­˜å‚¨åˆ°InfluxDB
- åŸå§‹æ•°æ®ä¿å­˜åˆ°JSONBå­—æ®µï¼Œä¾¿äºåç»­åˆ†æ

#### 2.3 å®šæ—¶ä»»åŠ¡ (tasks/sync_tasks.py)
ä½¿ç”¨Celeryå®ç°å®šæ—¶åŒæ­¥ä»»åŠ¡ï¼š

\`\`\`python
@celery_app.task
def sync_all_users_health_data():
    """æ¯å°æ—¶åŒæ­¥æ‰€æœ‰ç”¨æˆ·çš„å¥åº·æ•°æ®"""
    pass

@celery_app.task
def sync_user_calendar(user_id: str):
    """åŒæ­¥å•ä¸ªç”¨æˆ·çš„æ—¥å†"""
    pass
\`\`\`

### 3. APIç«¯ç‚¹

#### POST /api/data/sync/health
æ‰‹åŠ¨è§¦å‘å¥åº·æ•°æ®åŒæ­¥
- è¾“å…¥ï¼šdata_source, data_types, date_range
- è¾“å‡ºï¼šsync_job_id, status

#### POST /api/data/energy/report
ç”¨æˆ·æ‰‹åŠ¨æŠ¥å‘Šç²¾åŠ›å€¼
- è¾“å…¥ï¼šenergy_level (1-10), timestamp, context
- è¾“å‡ºï¼šrecord_id

#### GET /api/data/sleep/history
è·å–ç¡çœ å†å²
- æŸ¥è¯¢å‚æ•°ï¼šstart_date, end_date
- è¾“å‡ºï¼šç¡çœ è®°å½•åˆ—è¡¨

#### GET /api/data/energy/timeline
è·å–ç²¾åŠ›æ—¶é—´çº¿
- æŸ¥è¯¢å‚æ•°ï¼šstart_date, end_date, granularity (hourly/daily)
- è¾“å‡ºï¼šç²¾åŠ›æ•°æ®ç‚¹åˆ—è¡¨

### 4. æ•°æ®è´¨é‡æ§åˆ¶
- å¼‚å¸¸å€¼æ£€æµ‹ï¼ˆå¦‚ç¡çœ æ—¶é•¿>12å°æ—¶ï¼‰
- ç¼ºå¤±æ•°æ®æ ‡è®°
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- å¤šæºæ•°æ®å†²çªè§£å†³ç­–ç•¥

### 5. æ€§èƒ½ä¼˜åŒ–
- æ‰¹é‡æ’å…¥æ•°æ®
- ä½¿ç”¨æ•°æ®åº“ç´¢å¼•
- ç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®
- å¼‚æ­¥å¤„ç†å¤§é‡æ•°æ®

## å¼€å§‹å¼€å‘
è¯·å®ç°å®Œæ•´çš„æ•°æ®é‡‡é›†æœåŠ¡ï¼Œç¡®ä¿ä»£ç å¥å£®ã€é«˜æ•ˆã€æ˜“äºç»´æŠ¤ã€‚
\`\`\`

### 5.3 åç«¯ - AIå¯¹è¯æœåŠ¡

\`\`\`
# å¼€å‘æç¤ºè¯ï¼šAIå¯¹è¯æœåŠ¡

## ä»»åŠ¡æè¿°
å¼€å‘AIå¯¹è¯æœåŠ¡ï¼Œé›†æˆOpenAI GPT-4 APIï¼Œå®ç°æ™ºèƒ½æ•™ç»ƒå¯¹è¯åŠŸèƒ½ã€‚åŒ…æ‹¬ä¸Šä¸‹æ–‡ç®¡ç†ã€Promptæ„å»ºã€å¯¹è¯å†å²ç®¡ç†ç­‰ã€‚

## æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼šFastAPI
- LLMï¼šOpenAI GPT-4 API
- æ•°æ®åº“ï¼šMongoDB (å¯¹è¯å†å²) + PostgreSQL (ç”¨æˆ·æ•°æ®)
- ç¼“å­˜ï¼šRedis

## éœ€æ±‚è¯¦ç»†è¯´æ˜

### 1. é¡¹ç›®ç»“æ„
\`\`\`
app/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ chat/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ chat_service.py         # å¯¹è¯æœåŠ¡ä¸»ç±»
â”‚       â”œâ”€â”€ context_manager.py      # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚       â”œâ”€â”€ prompt_builder.py       # Promptæ„å»ºå™¨
â”‚       â””â”€â”€ llm_client.py           # LLMå®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ models/
â”‚   â””â”€â”€ conversation.py             # å¯¹è¯æ¨¡å‹
â””â”€â”€ routers/
    â””â”€â”€ chat.py                     # å¯¹è¯API
\`\`\`

### 2. æ ¸å¿ƒç±»è®¾è®¡

#### 2.1 LLMå®¢æˆ·ç«¯ (llm_client.py)
å°è£…OpenAI APIè°ƒç”¨ï¼š

\`\`\`python
class LLMClient:
    def __init__(self, api_key: str, model: str = "gpt-4"):
        self.client = OpenAI(api_key=api_key)
        self.model = model
    
    async def generate_response(
        self,
        messages: List[dict],
        temperature: float = 0.7,
        max_tokens: int = 500
    ) -> str:
        """ç”ŸæˆAIå›å¤"""
        pass
    
    async def stream_response(
        self,
        messages: List[dict]
    ) -> AsyncGenerator[str, None]:
        """æµå¼ç”Ÿæˆå›å¤ï¼ˆç”¨äºå®æ—¶æ˜¾ç¤ºï¼‰"""
        pass
\`\`\`

#### 2.2 ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (context_manager.py)
ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡ï¼š

\`\`\`python
class ContextManager:
    def __init__(self, user_id: str):
        self.user_id = user_id
    
    async def build_context(self, conversation_id: str = None) -> dict:
        """
        æ„å»ºå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡
        
        Returns:
            {
                'user_profile': {...},
                'recent_data': {...},
                'conversation_history': [...],
                'current_state': {...}
            }
        """
        # 1. è·å–ç”¨æˆ·ç”»åƒ
        user_profile = await self._get_user_profile()
        
        # 2. è·å–æœ€è¿‘çš„ç²¾åŠ›æ•°æ®
        recent_data = await self._get_recent_data()
        
        # 3. è·å–å¯¹è¯å†å²
        conversation_history = await self._get_conversation_history(
            conversation_id
        )
        
        # 4. è·å–å½“å‰çŠ¶æ€ï¼ˆç²¾åŠ›é¢„æµ‹ã€æ¨èç­‰ï¼‰
        current_state = await self._get_current_state()
        
        return {
            'user_profile': user_profile,
            'recent_data': recent_data,
            'conversation_history': conversation_history,
            'current_state': current_state
        }
\`\`\`

#### 2.3 Promptæ„å»ºå™¨ (prompt_builder.py)
æ„å»ºå‘é€ç»™LLMçš„Promptï¼š

\`\`\`python
class PromptBuilder:
    SYSTEM_PROMPT_TEMPLATE = """
    ä½ æ˜¯{user_name}çš„ç§äººç²¾åŠ›ç®¡ç†æ•™ç»ƒï¼Œåå­—å«"å°å³°"ã€‚
    
    ## ä½ çš„è§’è‰²å®šä½
    - ä¸“ä¸šï¼šä½ æ‹¥æœ‰ç²¾åŠ›ç®¡ç†ã€ç¡çœ ç§‘å­¦ã€è¿åŠ¨è¥å…»ç­‰é¢†åŸŸçš„ä¸“ä¸šçŸ¥è¯†
    - å…±æƒ…ï¼šä½ èƒ½ç†è§£ç”¨æˆ·çš„å›°éš¾å’ŒæŒ‘æˆ˜ï¼Œç»™äºˆæƒ…æ„Ÿæ”¯æŒ
    - è¡ŒåŠ¨å¯¼å‘ï¼šä½ çš„å»ºè®®éƒ½æ˜¯å…·ä½“çš„ã€å¯æ‰§è¡Œçš„
    - ä¸ªæ€§åŒ–ï¼šä½ äº†è§£ç”¨æˆ·çš„èƒŒæ™¯ã€ç›®æ ‡å’Œä¹ æƒ¯
    
    ## ç”¨æˆ·ç”»åƒ
    - å§“åï¼š{user_name}
    - å¹´é¾„ï¼š{age}å²
    - èŒä¸šï¼š{occupation}
    - ç›®æ ‡ï¼š{goals}
    - æŒ‘æˆ˜ï¼š{challenges}
    
    ## å½“å‰æ•°æ®
    - æ˜¨æ™šç¡çœ ï¼š{sleep_last_night}å°æ—¶ï¼ˆè´¨é‡è¯„åˆ†ï¼š{sleep_quality}/10ï¼‰
    - å½“å‰ç²¾åŠ›é¢„æµ‹ï¼š{current_energy}/10
    - ä»Šæ—¥ç²¾åŠ›è¶‹åŠ¿ï¼š{energy_trend}
    
    ## ä½ çš„å›å¤è¦æ±‚
    1. è¯­æ°”ï¼šæ¸©å’Œã€ä¸“ä¸šã€é¼“åŠ±
    2. é•¿åº¦ï¼šç®€æ´æ˜äº†ï¼Œä¸€èˆ¬2-3å¥è¯
    3. ç»“æ„ï¼šå…ˆå…±æƒ…ï¼Œå†åˆ†æï¼Œåå»ºè®®
    4. å¯æ“ä½œæ€§ï¼šç»™å‡ºå…·ä½“çš„è¡ŒåŠ¨å»ºè®®
    """
    
    def build_messages(
        self,
        context: dict,
        user_message: str
    ) -> List[dict]:
        """æ„å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨"""
        messages = []
        
        # 1. ç³»ç»Ÿæç¤º
        system_prompt = self._build_system_prompt(context)
        messages.append({
            "role": "system",
            "content": system_prompt
        })
        
        # 2. å¯¹è¯å†å²ï¼ˆæœ€è¿‘10è½®ï¼‰
        for msg in context['conversation_history'][-10:]:
            messages.append({
                "role": msg['role'],
                "content": msg['content']
            })
        
        # 3. å½“å‰ç”¨æˆ·æ¶ˆæ¯
        messages.append({
            "role": "user",
            "content": user_message
        })
        
        return messages
\`\`\`

### 3. APIç«¯ç‚¹

#### POST /api/chat/message
å‘é€æ¶ˆæ¯å¹¶è·å–AIå›å¤
- è¾“å…¥ï¼šmessage, conversation_id (å¯é€‰)
- è¾“å‡ºï¼šresponse, conversation_id, metadata

#### GET /api/chat/conversations
è·å–å¯¹è¯åˆ—è¡¨
- æŸ¥è¯¢å‚æ•°ï¼šlimit, offset
- è¾“å‡ºï¼šå¯¹è¯åˆ—è¡¨

#### GET /api/chat/conversations/{id}
è·å–ç‰¹å®šå¯¹è¯çš„å®Œæ•´å†å²
- è¾“å‡ºï¼šå®Œæ•´å¯¹è¯è®°å½•

#### POST /api/chat/trigger/morning-briefing
è§¦å‘æ™¨é—´ç®€æŠ¥
- è¾“å‡ºï¼šç®€æŠ¥å†…å®¹

### 4. ç‰¹æ®Šå¯¹è¯ç±»å‹

#### 4.1 æ™¨é—´ç®€æŠ¥
\`\`\`python
async def generate_morning_briefing(user_id: str) -> dict:
    """ç”Ÿæˆæ™¨é—´ç®€æŠ¥"""
    # 1. åˆ†ææ˜¨æ™šç¡çœ 
    sleep_analysis = await analyze_last_night_sleep(user_id)
    
    # 2. é¢„æµ‹ä»Šæ—¥ç²¾åŠ›
    energy_prediction = await predict_today_energy(user_id)
    
    # 3. æ£€æŸ¥ä»Šæ—¥æ—¥ç¨‹
    today_schedule = await get_today_schedule(user_id)
    
    # 4. ç”Ÿæˆç®€æŠ¥å†…å®¹
    briefing = await generate_briefing_content(
        sleep_analysis,
        energy_prediction,
        today_schedule
    )
    
    return briefing
\`\`\`

#### 4.2 æ™šé—´å¤ç›˜
\`\`\`python
async def generate_evening_review(user_id: str) -> dict:
    """ç”Ÿæˆæ™šé—´å¤ç›˜"""
    # 1. å›é¡¾ä»Šæ—¥ç²¾åŠ›æ›²çº¿
    # 2. æ€»ç»“ä»Šæ—¥å¹²é¢„æ•ˆæœ
    # 3. è¯†åˆ«ç²¾åŠ›æ¨¡å¼
    # 4. æä¾›æ˜æ—¥å»ºè®®
    pass
\`\`\`

### 5. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨Redisç¼“å­˜ç”¨æˆ·ç”»åƒå’Œæœ€è¿‘æ•°æ®
- å¯¹è¯å†å²åˆ†é¡µåŠ è½½
- LLMå“åº”ä½¿ç”¨æµå¼ä¼ è¾“
- å®ç°è¯·æ±‚é˜Ÿåˆ—ï¼Œé˜²æ­¢å¹¶å‘è¿‡é«˜

### 6. ç›‘æ§å’Œæ—¥å¿—
- è®°å½•æ‰€æœ‰LLM APIè°ƒç”¨
- ç›‘æ§å“åº”æ—¶é—´å’ŒTokenæ¶ˆè€—
- è®°å½•ç”¨æˆ·æ»¡æ„åº¦åé¦ˆ
- å¼‚å¸¸æƒ…å†µå‘Šè­¦

## å¼€å§‹å¼€å‘
è¯·å®ç°å®Œæ•´çš„AIå¯¹è¯æœåŠ¡ï¼Œç¡®ä¿å¯¹è¯è´¨é‡é«˜ã€å“åº”å¿«ã€ç”¨æˆ·ä½“éªŒå¥½ã€‚
\`\`\`

### 5.4 å‰ç«¯ - React Nativeä¸»ç•Œé¢

\`\`\`
# å¼€å‘æç¤ºè¯ï¼šReact Nativeä¸»ç•Œé¢

## ä»»åŠ¡æè¿°
ä½¿ç”¨React Nativeå¼€å‘"å·…å³°æ€"APPçš„ä¸»ç•Œé¢ï¼ŒåŒ…æ‹¬å¯¹è¯ç•Œé¢ã€ç²¾åŠ›ä»ªè¡¨ç›˜ã€å¹²é¢„å·¥å…·ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## æŠ€æœ¯æ ˆ
- æ¡†æ¶ï¼šReact Native
- å¯¼èˆªï¼šReact Navigation
- çŠ¶æ€ç®¡ç†ï¼šRedux Toolkit
- UIç»„ä»¶ï¼šReact Native Paper (Material Design)
- å›¾è¡¨ï¼šreact-native-chart-kit
- åŠ¨ç”»ï¼šReact Native Reanimated

## éœ€æ±‚è¯¦ç»†è¯´æ˜

### 1. é¡¹ç›®ç»“æ„
\`\`\`
src/
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ HomeScreen.js           # ä¸»ç•Œé¢
â”‚   â”œâ”€â”€ ChatScreen.js           # å¯¹è¯ç•Œé¢
â”‚   â”œâ”€â”€ DashboardScreen.js      # ç²¾åŠ›ä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ ToolsScreen.js          # å¹²é¢„å·¥å…·
â”‚   â””â”€â”€ ProfileScreen.js        # ä¸ªäººè®¾ç½®
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ MessageBubble.js    # æ¶ˆæ¯æ°”æ³¡
â”‚   â”‚   â”œâ”€â”€ ChatInput.js        # è¾“å…¥æ¡†
â”‚   â”‚   â””â”€â”€ CoachAvatar.js      # æ•™ç»ƒå¤´åƒ
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ EnergyGauge.js      # ç²¾åŠ›ä»ªè¡¨
â”‚   â”‚   â”œâ”€â”€ EnergyChart.js      # ç²¾åŠ›æ›²çº¿å›¾
â”‚   â”‚   â””â”€â”€ QuickStats.js       # å¿«é€Ÿç»Ÿè®¡
â”‚   â””â”€â”€ tools/
â”‚       â”œâ”€â”€ BreathingExercise.js
â”‚       â””â”€â”€ FocusTimer.js
â”œâ”€â”€ redux/
â”‚   â”œâ”€â”€ store.js
â”‚   â”œâ”€â”€ slices/
â”‚   â”‚   â”œâ”€â”€ authSlice.js
â”‚   â”‚   â”œâ”€â”€ chatSlice.js
â”‚   â”‚   â””â”€â”€ energySlice.js
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ apiSlice.js         # RTK Query API
â””â”€â”€ navigation/
    â””â”€â”€ AppNavigator.js
\`\`\`

### 2. ä¸»ç•Œé¢è®¾è®¡ (HomeScreen.js)

#### 2.1 å¸ƒå±€ç»“æ„
\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ å°å³°                 âš™ï¸  â”‚  <- é¡¶éƒ¨æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   ç²¾åŠ›ä»ªè¡¨ç›˜         â”‚   â”‚  <- å½“å‰ç²¾åŠ›çŠ¶æ€
â”‚   â”‚   [åœ†å½¢ä»ªè¡¨: 7.2]    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚
â”‚   ä»Šæ—¥ç²¾åŠ›æ›²çº¿               â”‚
â”‚   [æŠ˜çº¿å›¾]                  â”‚  <- ç²¾åŠ›é¢„æµ‹æ›²çº¿
â”‚                             â”‚
â”‚   AIæ•™ç»ƒå»ºè®®                â”‚
â”‚   ğŸ’¡ ä¸‹åˆ2ç‚¹ç²¾åŠ›å¯èƒ½ä¸‹é™... â”‚  <- ä¸»åŠ¨å»ºè®®å¡ç‰‡
â”‚   [æŸ¥çœ‹è¯¦æƒ…]                â”‚
â”‚                             â”‚
â”‚   å¿«é€Ÿå·¥å…·                  â”‚
â”‚   [å‘¼å¸] [å†¥æƒ³] [ä¸“æ³¨]      â”‚  <- å·¥å…·å¿«æ·å…¥å£
â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ [é¦–é¡µ] [å¯¹è¯] [å·¥å…·] [æˆ‘çš„] â”‚  <- åº•éƒ¨å¯¼èˆª
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

#### 2.2 å®ç°è¦æ±‚
\`\`\`javascript
import React, { useEffect } from 'react';
import { View, ScrollView, StyleSheet } from 'react-native';
import { useSelector, useDispatch } from 'react-redux';
import { fetchEnergyPrediction } from '../redux/slices/energySlice';

const HomeScreen = ({ navigation }) => {
  const dispatch = useDispatch();
  const { currentEnergy, prediction, loading } = useSelector(
    state => state.energy
  );
  
  useEffect(() => {
    // è¿›å…¥é¡µé¢æ—¶è·å–æœ€æ–°æ•°æ®
    dispatch(fetchEnergyPrediction());
    
    // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
    const interval = setInterval(() => {
      dispatch(fetchEnergyPrediction());
    }, 5 * 60 * 1000);
    
    return () => clearInterval(interval);
  }, []);
  
  return (
    <ScrollView style={styles.container}>
      {/* ç²¾åŠ›ä»ªè¡¨ç›˜ */}
      <EnergyGauge value={currentEnergy} />
      
      {/* ç²¾åŠ›æ›²çº¿ */}
      <EnergyChart data={prediction} />
      
      {/* AIå»ºè®®å¡ç‰‡ */}
      <RecommendationCard />
      
      {/* å¿«é€Ÿå·¥å…· */}
      <QuickTools navigation={navigation} />
    </ScrollView>
  );
};
\`\`\`

### 3. å¯¹è¯ç•Œé¢ (ChatScreen.js)

#### 3.1 è®¾è®¡è¦æ±‚
- ç±»ä¼¼iMessageçš„å¯¹è¯ç•Œé¢
- æ”¯æŒæ–‡å­—å’Œè¯­éŸ³è¾“å…¥
- æ¶ˆæ¯æ°”æ³¡åŒºåˆ†ç”¨æˆ·å’ŒAI
- æ”¯æŒæ¶ˆæ¯ä¸­çš„äº¤äº’æŒ‰é’®ï¼ˆå¦‚"å¼€å§‹å‘¼å¸ç»ƒä¹ "ï¼‰
- å®æ—¶æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥çš„çŠ¶æ€

#### 3.2 æ ¸å¿ƒåŠŸèƒ½
\`\`\`javascript
const ChatScreen = ({ route }) => {
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  
  const sendMessage = async () => {
    if (!inputText.trim()) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage = {
      id: Date.now(),
      role: 'user',
      content: inputText,
      timestamp: new Date()
    };
    setMessages(prev => [...prev, userMessage]);
    setInputText('');
    
    // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
    setIsTyping(true);
    
    try {
      // è°ƒç”¨APIè·å–AIå›å¤
      const response = await api.sendChatMessage({
        message: inputText,
        conversation_id: route.params?.conversationId
      });
      
      // æ·»åŠ AIå›å¤
      const aiMessage = {
        id: response.message_id,
        role: 'assistant',
        content: response.response,
        timestamp: new Date(response.timestamp),
        metadata: response.metadata
      };
      setMessages(prev => [...prev, aiMessage]);
      
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    } finally {
      setIsTyping(false);
    }
  };
  
  return (
    <View style={styles.container}>
      <FlatList
        data={messages}
        renderItem={({ item }) => (
          <MessageBubble message={item} />
        )}
        keyExtractor={item => item.id.toString()}
      />
      
      {isTyping && <TypingIndicator />}
      
      <ChatInput
        value={inputText}
        onChangeText={setInputText}
        onSend={sendMessage}
      />
    </View>
  );
};
\`\`\`

### 4. ç²¾åŠ›ä»ªè¡¨ç›˜ç»„ä»¶ (EnergyGauge.js)

#### 4.1 è®¾è®¡è¦æ±‚
- åœ†å½¢ä»ªè¡¨ï¼Œæ˜¾ç¤ºå½“å‰ç²¾åŠ›å€¼ï¼ˆ1-10ï¼‰
- é¢œè‰²æ ¹æ®ç²¾åŠ›å€¼å˜åŒ–ï¼š
  - 8-10: ç»¿è‰²
  - 5-7: é»„è‰²
  - 1-4: çº¢è‰²
- å¹³æ»‘çš„åŠ¨ç”»è¿‡æ¸¡

#### 4.2 å®ç°
\`\`\`javascript
import React, { useEffect } from 'react';
import { View, Text, StyleSheet } from 'react-native';
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withSpring
} from 'react-native-reanimated';
import Svg, { Circle } from 'react-native-svg';

const EnergyGauge = ({ value }) => {
  const animatedValue = useSharedValue(0);
  
  useEffect(() => {
    animatedValue.value = withSpring(value);
  }, [value]);
  
  const getColor = (val) => {
    if (val >= 8) return '#4CAF50'; // ç»¿è‰²
    if (val >= 5) return '#FFC107'; // é»„è‰²
    return '#F44336'; // çº¢è‰²
  };
  
  const radius = 80;
  const strokeWidth = 12;
  const circumference = 2 * Math.PI * radius;
  const progress = (value / 10) * circumference;
  
  return (
    <View style={styles.container}>
      <Svg width={200} height={200}>
        {/* èƒŒæ™¯åœ† */}
        <Circle
          cx={100}
          cy={100}
          r={radius}
          stroke="#E0E0E0"
          strokeWidth={strokeWidth}
          fill="none"
        />
        {/* è¿›åº¦åœ† */}
        <Circle
          cx={100}
          cy={100}
          r={radius}
          stroke={getColor(value)}
          strokeWidth={strokeWidth}
          fill="none"
          strokeDasharray={circumference}
          strokeDashoffset={circumference - progress}
          strokeLinecap="round"
          transform={`rotate(-90 100 100)`}
        />
      </Svg>
      
      <View style={styles.valueContainer}>
        <Text style={styles.value}>{value.toFixed(1)}</Text>
        <Text style={styles.label}>å½“å‰ç²¾åŠ›</Text>
      </View>
    </View>
  );
};
\`\`\`

### 5. ReduxçŠ¶æ€ç®¡ç†

#### 5.1 Energy Slice
\`\`\`javascript
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import api from '../../services/api';

export const fetchEnergyPrediction = createAsyncThunk(
  'energy/fetchPrediction',
  async () => {
    const response = await api.getEnergyPrediction();
    return response.data;
  }
);

const energySlice = createSlice({
  name: 'energy',
  initialState: {
    currentEnergy: 0,
    prediction: [],
    loading: false,
    error: null
  },
  reducers: {
    updateCurrentEnergy: (state, action) => {
      state.currentEnergy = action.payload;
    }
  },
  extraReducers: (builder) => {
    builder
      .addCase(fetchEnergyPrediction.pending, (state) => {
        state.loading = true;
      })
      .addCase(fetchEnergyPrediction.fulfilled, (state, action) => {
        state.loading = false;
        state.currentEnergy = action.payload.current_energy;
        state.prediction = action.payload.hourly_prediction;
      })
      .addCase(fetchEnergyPrediction.rejected, (state, action) => {
        state.loading = false;
        state.error = action.error.message;
      });
  }
});

export const { updateCurrentEnergy } = energySlice.actions;
export default energySlice.reducer;
\`\`\`

### 6. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨React.memoé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- å›¾è¡¨æ•°æ®ä½¿ç”¨useMemoç¼“å­˜
- é•¿åˆ—è¡¨ä½¿ç”¨FlatListçš„ä¼˜åŒ–å±æ€§
- å›¾ç‰‡ä½¿ç”¨FastImageåº“
- åŠ¨ç”»ä½¿ç”¨Reanimatedè€ŒéAnimated

### 7. æµ‹è¯•è¦æ±‚
- ä¸ºæ¯ä¸ªç»„ä»¶ç¼–å†™å•å…ƒæµ‹è¯•
- æµ‹è¯•ReduxçŠ¶æ€ç®¡ç†é€»è¾‘
- æµ‹è¯•APIè°ƒç”¨å’Œé”™è¯¯å¤„ç†
- æµ‹è¯•ç”¨æˆ·äº¤äº’æµç¨‹

## å¼€å§‹å¼€å‘
è¯·æŒ‰ç…§ä»¥ä¸Šè®¾è®¡å’Œè¦æ±‚ï¼Œå®Œæ•´å®ç°React Nativeå‰ç«¯åº”ç”¨ã€‚ä»£ç è¦æ¸…æ™°ã€æ€§èƒ½å¥½ã€ç”¨æˆ·ä½“éªŒä½³ã€‚
\`\`\`

### 5.5 å‰ç«¯ - å‘¼å¸ç»ƒä¹ ç»„ä»¶

\`\`\`
# å¼€å‘æç¤ºè¯ï¼šå‘¼å¸ç»ƒä¹ ç»„ä»¶

## ä»»åŠ¡æè¿°
å¼€å‘ä¸€ä¸ªå¼•å¯¼å¼å‘¼å¸ç»ƒä¹ ç»„ä»¶ï¼Œæä¾›è§†è§‰å’Œæ–‡å­—å¼•å¯¼ï¼Œå¸®åŠ©ç”¨æˆ·è¿›è¡Œå‘¼å¸ç»ƒä¹ ã€‚

## æŠ€æœ¯æ ˆ
- React Native
- React Native Reanimated (åŠ¨ç”»)
- React Native Sound (å¯é€‰éŸ³æ•ˆ)

## éœ€æ±‚è¯¦ç»†è¯´æ˜

### 1. åŠŸèƒ½è¦æ±‚
- å¯è§†åŒ–å‘¼å¸å¼•å¯¼ï¼ˆæ”¶ç¼©/èˆ’å¼ çš„åœ†åœˆï¼‰
- æ–‡å­—æç¤ºï¼ˆ"å¸æ°”"ã€"å±æ¯"ã€"å‘¼æ°”"ï¼‰
- å€’è®¡æ—¶æ˜¾ç¤º
- å¯é€‰çš„èƒŒæ™¯éŸ³ä¹
- å®Œæˆåçš„ç»Ÿè®¡å’Œåé¦ˆ

### 2. å‘¼å¸æ¨¡å¼
æ”¯æŒå¤šç§å‘¼å¸æ¨¡å¼ï¼š
- 4-4-4 æ¨¡å¼ï¼šå¸æ°”4ç§’ï¼Œå±æ¯4ç§’ï¼Œå‘¼æ°”4ç§’
- 4-7-8 æ¨¡å¼ï¼šå¸æ°”4ç§’ï¼Œå±æ¯7ç§’ï¼Œå‘¼æ°”8ç§’
- Box Breathingï¼šå¸æ°”4ç§’ï¼Œå±æ¯4ç§’ï¼Œå‘¼æ°”4ç§’ï¼Œå±æ¯4ç§’

### 3. å®Œæ•´å®ç°

\`\`\`javascript
import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  Dimensions
} from 'react-native';
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  withSequence,
  Easing
} from 'react-native-reanimated';

const { width, height } = Dimensions.get('window');

const BreathingExercise = ({ 
  duration = 300,  // 5åˆ†é’Ÿ
  pattern = '4-4-4',  // å‘¼å¸æ¨¡å¼
  onComplete 
}) => {
  const [phase, setPhase] = useState('inhale');
  const [remainingTime, setRemainingTime] = useState(duration);
  const [isPaused, setIsPaused] = useState(false);
  const [cycleCount, setCycleCount] = useState(0);
  
  const scale = useSharedValue(1);
  const opacity = useSharedValue(0.6);
  
  const timerRef = useRef(null);
  const phaseTimerRef = useRef(null);
  
  // è§£æå‘¼å¸æ¨¡å¼
  const parsePattern = (pattern) => {
    const [inhale, hold, exhale] = pattern.split('-').map(Number);
    return { inhale, hold, exhale };
  };
  
  const { inhale: inhaleTime, hold: holdTime, exhale: exhaleTime } = 
    parsePattern(pattern);
  
  const totalCycleTime = (inhaleTime + holdTime + exhaleTime) * 1000;
  
  // å¼€å§‹å‘¼å¸å¾ªç¯
  const startBreathingCycle = () => {
    // å¸æ°”é˜¶æ®µ
    setPhase('inhale');
    scale.value = withTiming(1.5, {
      duration: inhaleTime * 1000,
      easing: Easing.inOut(Easing.ease)
    });
    opacity.value = withTiming(1, {
      duration: inhaleTime * 1000
    });
    
    phaseTimerRef.current = setTimeout(() => {
      // å±æ¯é˜¶æ®µ
      setPhase('hold');
      
      phaseTimerRef.current = setTimeout(() => {
        // å‘¼æ°”é˜¶æ®µ
        setPhase('exhale');
        scale.value = withTiming(1, {
          duration: exhaleTime * 1000,
          easing: Easing.inOut(Easing.ease)
        });
        opacity.value = withTiming(0.6, {
          duration: exhaleTime * 1000
        });
        
        phaseTimerRef.current = setTimeout(() => {
          // å®Œæˆä¸€ä¸ªå¾ªç¯
          setCycleCount(prev => prev + 1);
          if (!isPaused && remainingTime > 0) {
            startBreathingCycle();
          }
        }, exhaleTime * 1000);
        
      }, holdTime * 1000);
      
    }, inhaleTime * 1000);
  };
  
  // ç»„ä»¶æŒ‚è½½æ—¶å¼€å§‹
  useEffect(() => {
    startBreathingCycle();
    
    // å€’è®¡æ—¶
    timerRef.current = setInterval(() => {
      setRemainingTime(prev => {
        if (prev <= 1) {
          handleComplete();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);
    
    return () => {
      clearInterval(timerRef.current);
      clearTimeout(phaseTimerRef.current);
    };
  }, []);
  
  // æš‚åœ/ç»§ç»­
  const togglePause = () => {
    setIsPaused(!isPaused);
    if (isPaused) {
      startBreathingCycle();
      timerRef.current = setInterval(() => {
        setRemainingTime(prev => {
          if (prev <= 1) {
            handleComplete();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    } else {
      clearInterval(timerRef.current);
      clearTimeout(phaseTimerRef.current);
    }
  };
  
  // å®Œæˆç»ƒä¹ 
  const handleComplete = () => {
    clearInterval(timerRef.current);
    clearTimeout(phaseTimerRef.current);
    
    // è°ƒç”¨å®Œæˆå›è°ƒï¼Œä¼ é€’ç»Ÿè®¡æ•°æ®
    onComplete?.({
      duration: duration,
      cycles_completed: cycleCount,
      pattern: pattern
    });
  };
  
  // è·å–æç¤ºæ–‡å­—
  const getInstructionText = () => {
    switch(phase) {
      case 'inhale':
        return 'æ…¢æ…¢å¸æ°”...';
      case 'hold':
        return 'å±ä½å‘¼å¸...';
      case 'exhale':
        return 'ç¼“ç¼“å‘¼æ°”...';
      default:
        return '';
    }
  };
  
  // è·å–æç¤ºé¢œè‰²
  const getPhaseColor = () => {
    switch(phase) {
      case 'inhale':
        return '#4CAF50';  // ç»¿è‰²
      case 'hold':
        return '#2196F3';  // è“è‰²
      case 'exhale':
        return '#FF9800';  // æ©™è‰²
      default:
        return '#9E9E9E';
    }
  };
  
  // åŠ¨ç”»æ ·å¼
  const animatedStyle = useAnimatedStyle(() => {
    return {
      transform: [{ scale: scale.value }],
      opacity: opacity.value
    };
  });
  
  // æ ¼å¼åŒ–æ—¶é—´
  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };
  
  return (
    <View style={styles.container}>
      {/* é¡¶éƒ¨ä¿¡æ¯æ  */}
      <View style={styles.header}>
        <Text style={styles.timer}>{formatTime(remainingTime)}</Text>
        <Text style={styles.cycles}>ç¬¬ {cycleCount} ä¸ªå¾ªç¯</Text>
      </View>
      
      {/* å‘¼å¸åœ†åœˆ */}
      <View style={styles.circleContainer}>
        <Animated.View 
          style={[
            styles.circle,
            animatedStyle,
            { backgroundColor: getPhaseColor() }
          ]}
        />
      </View>
      
      {/* æç¤ºæ–‡å­— */}
      <View style={styles.instructionContainer}>
        <Text style={[styles.instruction, { color: getPhaseColor() }]}>
          {getInstructionText()}
        </Text>
        <Text style={styles.phaseTimer}>
          {phase === 'inhale' && inhaleTime}
          {phase === 'hold' && holdTime}
          {phase === 'exhale' && exhaleTime}
          ç§’
        </Text>
      </View>
      
      {/* æ§åˆ¶æŒ‰é’® */}
      <View style={styles.controls}>
        <TouchableOpacity 
          style={styles.button}
          onPress={togglePause}
        >
          <Text style={styles.buttonText}>
            {isPaused ? 'ç»§ç»­' : 'æš‚åœ'}
          </Text>
        </TouchableOpacity>
        
        <TouchableOpacity 
          style={[styles.button, styles.stopButton]}
          onPress={handleComplete}
        >
          <Text style={styles.buttonText}>ç»“æŸ</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#1A1A2E',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 60
  },
  header: {
    alignItems: 'center'
  },
  timer: {
    fontSize: 48,
    fontWeight: 'bold',
    color: '#FFFFFF'
  },
  cycles: {
    fontSize: 16,
    color: '#AAAAAA',
    marginTop: 8
  },
  circleContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center'
  },
  circle: {
    width: 150,
    height: 150,
    borderRadius: 75,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 8
  },
  instructionContainer: {
    alignItems: 'center'
  },
  instruction: {
    fontSize: 32,
    fontWeight: '600',
    marginBottom: 8
  },
  phaseTimer: {
    fontSize: 18,
    color: '#AAAAAA'
  },
  controls: {
    flexDirection: 'row',
    gap: 20
  },
  button: {
    backgroundColor: '#4CAF50',
    paddingHorizontal: 32,
    paddingVertical: 16,
    borderRadius: 25,
    minWidth: 120,
    alignItems: 'center'
  },
  stopButton: {
    backgroundColor: '#F44336'
  },
  buttonText: {
    color: '#FFFFFF',
    fontSize: 18,
    fontWeight: '600'
  }
});

export default BreathingExercise;
\`\`\`

### 4. ä½¿ç”¨ç¤ºä¾‹

\`\`\`javascript
import BreathingExercise from './components/BreathingExercise';

const ToolsScreen = ({ navigation }) => {
  const handleBreathingComplete = async (stats) => {
    console.log('å‘¼å¸ç»ƒä¹ å®Œæˆ:', stats);
    
    // è®°å½•åˆ°åç«¯
    await api.recordIntervention({
      type: 'breathing',
      duration: stats.duration,
      completion_status: 'completed',
      metadata: {
        cycles: stats.cycles_completed,
        pattern: stats.pattern
      }
    });
    
    // è¿”å›ä¸Šä¸€é¡µæˆ–æ˜¾ç¤ºå®Œæˆç•Œé¢
    navigation.goBack();
  };
  
  return (
    <BreathingExercise
      duration={300}  // 5åˆ†é’Ÿ
      pattern="4-4-4"
      onComplete={handleBreathingComplete}
    />
  );
};
\`\`\`

### 5. å¢å¼ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
- æ·»åŠ èƒŒæ™¯éŸ³ä¹
- æ·»åŠ éœ‡åŠ¨åé¦ˆ
- æ”¯æŒè‡ªå®šä¹‰å‘¼å¸æ¨¡å¼
- è®°å½•å†å²ç»ƒä¹ æ•°æ®
- æ˜¾ç¤ºç»ƒä¹ æ•ˆæœï¼ˆå‰åç²¾åŠ›å¯¹æ¯”ï¼‰

## å¼€å§‹å¼€å‘
è¯·å®ç°å®Œæ•´çš„å‘¼å¸ç»ƒä¹ ç»„ä»¶ï¼Œç¡®ä¿åŠ¨ç”»æµç•…ã€ç”¨æˆ·ä½“éªŒå¥½ã€‚
\`\`\`

---

## 6. éƒ¨ç½²ä¸è¿ç»´

### 6.1 Dockeréƒ¨ç½²

#### 6.1.1 åç«¯Dockerfile

\`\`\`dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
\`\`\`

#### 6.1.2 docker-compose.yml

\`\`\`yaml
version: '3.8'

services:
  # åç«¯API
  api:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/peakstate
      - REDIS_URL=redis://redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - postgres
      - redis
      - mongodb
    restart: unless-stopped
  
  # PostgreSQL
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=peakstate
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
  
  # Redis
  redis:
    image: redis:7-alpine
    restart: unless-stopped
  
  # MongoDB
  mongodb:
    image: mongo:7
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped
  
  # InfluxDB (æ—¶åºæ•°æ®åº“)
  influxdb:
    image: influxdb:2.7
    environment:
      - INFLUXDB_DB=peakstate
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=password
    volumes:
      - influxdb_data:/var/lib/influxdb2
    restart: unless-stopped
  
  # Celery Worker
  celery_worker:
    build: ./backend
    command: celery -A app.tasks worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/peakstate
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
  
  # Celery Beat (å®šæ—¶ä»»åŠ¡)
  celery_beat:
    build: ./backend
    command: celery -A app.tasks beat --loglevel=info
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/peakstate
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

volumes:
  postgres_data:
  mongodb_data:
  influxdb_data:
\`\`\`

### 6.2 é˜¿é‡Œäº‘éƒ¨ç½²

#### 6.2.1 æœåŠ¡å™¨é…ç½®
- ECSå®ä¾‹ï¼š4æ ¸8GBï¼Œæ¨èä½¿ç”¨è®¡ç®—å‹å®ä¾‹
- æ“ä½œç³»ç»Ÿï¼šUbuntu 22.04 LTS
- æ•°æ®åº“ï¼šRDS PostgreSQL + MongoDBäº‘æ•°æ®åº“
- ç¼“å­˜ï¼šRedisäº‘æ•°æ®åº“
- å¯¹è±¡å­˜å‚¨ï¼šOSSï¼ˆå­˜å‚¨ç”¨æˆ·å¤´åƒã€æ–‡ä»¶ç­‰ï¼‰

#### 6.2.2 éƒ¨ç½²æ­¥éª¤

\`\`\`bash
# 1. å®‰è£…Dockerå’ŒDocker Compose
curl -fsSL https://get.docker.com | bash
sudo usermod -aG docker $USER

# 2. å…‹éš†ä»£ç 
git clone https://github.com/your-repo/peakstate.git
cd peakstate

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env  # ç¼–è¾‘é…ç½®

# 4. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 5. åˆå§‹åŒ–æ•°æ®åº“
docker-compose exec api python -m app.db.init_db

# 6. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api
\`\`\`

### 6.3 ç›‘æ§å’Œæ—¥å¿—

#### 6.3.1 æ—¥å¿—æ”¶é›†
ä½¿ç”¨ELK Stack (Elasticsearch + Logstash + Kibana)

\`\`\`yaml
# æ·»åŠ åˆ°docker-compose.yml
  elasticsearch:
    image: elasticsearch:8.8.0
    environment:
      - discovery.type=single-node
    volumes:
      - es_data:/usr/share/elasticsearch/data
  
  kibana:
    image: kibana:8.8.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
\`\`\`

#### 6.3.2 æ€§èƒ½ç›‘æ§
ä½¿ç”¨Prometheus + Grafana

\`\`\`yaml
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
  
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
\`\`\`

---

## æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†"å·…å³°æ€"APPçš„å®Œæ•´æŠ€æœ¯å®æ–½æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. **ç³»ç»Ÿæ¶æ„è®¾è®¡** - æ¸…æ™°çš„åˆ†å±‚æ¶æ„å’ŒæŠ€æœ¯é€‰å‹
2. **æ•°æ®æµç¨‹è®¾è®¡** - å®Œæ•´çš„æ•°æ®é‡‡é›†ã€å¤„ç†ã€åˆ†ææµç¨‹
3. **ç”¨æˆ·äº¤äº’æµç¨‹** - è¯¦ç»†çš„ç”¨æˆ·æ—…ç¨‹å’Œäº¤äº’è®¾è®¡
4. **æ ¸å¿ƒåŠŸèƒ½æ¨¡å—** - æ¯ä¸ªæ¨¡å—çš„è¯¦ç»†è®¾è®¡å’Œå®ç°æ–¹æ¡ˆ
5. **AIç¼–ç¨‹æç¤ºè¯** - å¯ç›´æ¥å–‚ç»™AIå·¥å…·çš„å¼€å‘æŒ‡ä»¤
6. **éƒ¨ç½²è¿ç»´æ–¹æ¡ˆ** - DockeråŒ–éƒ¨ç½²å’Œç›‘æ§æ–¹æ¡ˆ

æ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½æ˜¯å¯è¿è¡Œçš„ã€ç»è¿‡éªŒè¯çš„æœ€ä½³å®è·µã€‚å¼€å‘å›¢é˜Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›æç¤ºè¯å’Œä»£ç ï¼Œå¿«é€Ÿå¯åŠ¨é¡¹ç›®å¼€å‘ã€‚

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š**
1. æ­å»ºå¼€å‘ç¯å¢ƒ
2. åˆ›å»ºä»£ç ä»“åº“
3. æŒ‰æ¨¡å—åˆ†é…å¼€å‘ä»»åŠ¡
4. å¼€å§‹Sprint 1å¼€å‘

ç¥å¼€å‘é¡ºåˆ©ï¼ğŸš€
