"""
çŸ¥è¯†åº“é¢„ç­”æ¡ˆç”Ÿæˆè„šæœ¬
ç”Ÿæˆå¸¸è§é—®é¢˜çš„é¢„ç­”æ¡ˆï¼Œå­˜å…¥Qdrantå‘é‡æ•°æ®åº“

ç”¨é€”ï¼š
- ä¸ºL3ç¼“å­˜å±‚æä¾›é¢„ç”Ÿæˆçš„ç­”æ¡ˆ
- é™ä½ç®€å•é—®é¢˜çš„AIè°ƒç”¨æˆæœ¬
- æå‡å¸¸è§é—®é¢˜çš„å“åº”é€Ÿåº¦
"""

import asyncio
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
backend_dir = Path(__file__).parent.parent
sys.path.insert(0, str(backend_dir))

from loguru import logger


# å¸¸è§é—®é¢˜æ•°æ®åº“ (100+æ¡)
KNOWLEDGE_BASE = [
    # ===== é—®å€™ç±» (10æ¡) =====
    {
        "q": "ä½ å¥½",
        "a": "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIå¥åº·æ•™ç»ƒï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼ğŸ˜Š\n\næˆ‘å¯ä»¥å¸®ä½ :\nâ€¢ æŸ¥çœ‹å’Œåˆ†æå¥åº·æ•°æ®\nâ€¢ æä¾›ä¸ªæ€§åŒ–å»ºè®®\nâ€¢ å›ç­”å¥åº·ç›¸å…³é—®é¢˜\n\næœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©çš„å—ï¼Ÿ",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "æ—©ä¸Šå¥½",
        "a": "æ—©ä¸Šå¥½ï¼â˜€ï¸ æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼Œå¸Œæœ›ä½ ç²¾åŠ›å……æ²›ï¼\n\nä»Šå¤©æœ‰ä»€ä¹ˆå¥åº·ç›®æ ‡å—ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ åˆ¶å®šè®¡åˆ’ã€‚",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "æ™šä¸Šå¥½",
        "a": "æ™šä¸Šå¥½ï¼ğŸŒ™ è¾›è‹¦äº†ä¸€å¤©ï¼Œæ˜¯æ—¶å€™æ”¾æ¾ä¸€ä¸‹äº†ã€‚\n\néœ€è¦æˆ‘å¸®ä½ æŸ¥çœ‹ä»Šå¤©çš„å¥åº·æ•°æ®å—ï¼Ÿæˆ–è€…ç»™ä½ ä¸€äº›åŠ©çœ å»ºè®®ï¼Ÿ",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "å—¨",
        "a": "å—¨ï¼æˆ‘æ˜¯ä½ çš„AIå¥åº·æ•™ç»ƒï¼Œéšæ—¶ä¸ºä½ æœåŠ¡ï¼\n\næœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©çš„å—ï¼Ÿ",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "hi",
        "a": "Hi! I'm your AI health coach. How can I help you today?",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "hello",
        "a": "Hello! Nice to meet you! I'm here to help you with your health and wellness journey. What can I do for you?",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "åœ¨å—",
        "a": "åœ¨çš„ï¼æˆ‘24å°æ—¶åœ¨çº¿ï¼Œéšæ—¶ä¸ºä½ æœåŠ¡ã€‚æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„å—ï¼Ÿ",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "ä½ æ˜¯è°",
        "a": "æˆ‘æ˜¯ä½ çš„AIå¥åº·æ•™ç»ƒï¼ğŸ¤–\n\næˆ‘çš„åŠŸèƒ½ï¼š\nâ€¢ åˆ†æä½ çš„å¥åº·æ•°æ®ï¼ˆç¡çœ ã€å¿ƒç‡ã€è¿åŠ¨ç­‰ï¼‰\nâ€¢ æä¾›ä¸ªæ€§åŒ–çš„å¥åº·å»ºè®®\nâ€¢ å›ç­”å¥åº·ç›¸å…³é—®é¢˜\nâ€¢ å¸®åŠ©ä½ å»ºç«‹æ›´å¥½çš„ç”Ÿæ´»ä¹ æƒ¯\n\næˆ‘ä½¿ç”¨å…ˆè¿›çš„AIæŠ€æœ¯ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼šæˆ‘ä¸èƒ½æ›¿ä»£åŒ»ç”Ÿçš„è¯Šæ–­ï¼Œé‡åˆ°ä¸¥é‡å¥åº·é—®é¢˜è¯·åŠæ—¶å°±åŒ»ã€‚",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "ä½ èƒ½åšä»€ä¹ˆ",
        "a": "æˆ‘èƒ½å¸®ä½ åšè¿™äº›äº‹ï¼š\n\nğŸ“Š **æ•°æ®åˆ†æ**\nâ€¢ æŸ¥çœ‹ç¡çœ ã€å¿ƒç‡ã€è¿åŠ¨æ•°æ®\nâ€¢ åˆ†æå¥åº·è¶‹åŠ¿\nâ€¢ è¯„ä¼°èƒ½é‡æ°´å¹³\n\nğŸ’¡ **ä¸ªæ€§åŒ–å»ºè®®**\nâ€¢ æ”¹å–„ç¡çœ è´¨é‡\nâ€¢ æå‡èƒ½é‡æ°´å¹³\nâ€¢ ä¼˜åŒ–ç”Ÿæ´»ä¹ æƒ¯\n\nâ¤ï¸ **æƒ…æ„Ÿæ”¯æŒ**\nâ€¢ å€¾å¬ä½ çš„çƒ¦æ¼\nâ€¢ æä¾›å‡å‹å»ºè®®\nâ€¢ å¸®åŠ©ä½ å»ºç«‹ç§¯æå¿ƒæ€\n\næœ‰ä»€ä¹ˆå…·ä½“éœ€è¦å¸®åŠ©çš„å—ï¼Ÿ",
        "intent": "greeting",
        "complexity": 1
    },
    {
        "q": "è°¢è°¢",
        "a": "ä¸å®¢æ°”ï¼ğŸ˜Š å¾ˆé«˜å…´èƒ½å¸®åˆ°ä½ ã€‚\n\nå¦‚æœè¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œéšæ—¶é—®æˆ‘ï¼æˆ‘ä¼šä¸€ç›´åœ¨è¿™é‡Œæ”¯æŒä½ ã€‚",
        "intent": "confirmation",
        "complexity": 1
    },

    # ===== æ•°æ®æŸ¥è¯¢ç±» (20æ¡) =====
    {
        "q": "æˆ‘çš„ç¡çœ æ€ä¹ˆæ ·",
        "a": "è®©æˆ‘å¸®ä½ æŸ¥çœ‹æœ€è¿‘çš„ç¡çœ æ•°æ®...\n\nï¼ˆæ­£åœ¨è°ƒå–ä½ çš„ç¡çœ æ•°æ®ï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æŸ¥çœ‹æˆ‘çš„ç¡çœ æ•°æ®",
        "a": "å¥½çš„ï¼Œæ­£åœ¨ä¸ºä½ è°ƒå–ç¡çœ æ•°æ®...\n\nï¼ˆæŸ¥è¯¢ä¸­ï¼Œè¯·ç¨å€™ï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æˆ‘æ˜¨æ™šç¡å¾—å¥½å—",
        "a": "è®©æˆ‘æŸ¥çœ‹ä½ æ˜¨æ™šçš„ç¡çœ æƒ…å†µ...\n\nï¼ˆæ­£åœ¨åˆ†ææ˜¨æ™šçš„ç¡çœ æ•°æ®ï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æŸ¥çœ‹å¿ƒç‡",
        "a": "æ­£åœ¨ä¸ºä½ è°ƒå–å¿ƒç‡æ•°æ®...\n\nï¼ˆæŸ¥è¯¢ä¸­ï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æˆ‘çš„å¿ƒç‡æ­£å¸¸å—",
        "a": "è®©æˆ‘å¸®ä½ æŸ¥çœ‹å¿ƒç‡æ•°æ®å¹¶è¯„ä¼°...\n\nï¼ˆæ­£åœ¨åˆ†æï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æ˜¾ç¤ºæˆ‘çš„è¿åŠ¨æ•°æ®",
        "a": "å¥½çš„ï¼Œæ­£åœ¨è°ƒå–ä½ çš„è¿åŠ¨ç»Ÿè®¡...\n\nï¼ˆæŸ¥è¯¢ä¸­ï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æˆ‘ä»Šå¤©èµ°äº†å¤šå°‘æ­¥",
        "a": "è®©æˆ‘æŸ¥çœ‹ä½ ä»Šå¤©çš„æ­¥æ•°...\n\nï¼ˆæ­£åœ¨æŸ¥è¯¢æ­¥æ•°æ•°æ®ï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æˆ‘çš„å¥åº·æ•°æ®",
        "a": "æ­£åœ¨ä¸ºä½ æ±‡æ€»å¥åº·æ•°æ®...\n\nï¼ˆæŸ¥è¯¢ä¸­ï¼ŒåŒ…æ‹¬ç¡çœ ã€å¿ƒç‡ã€è¿åŠ¨ç­‰ï¼‰",
        "intent": "data_query",
        "complexity": 3
    },
    {
        "q": "æœ€è¿‘ç¡çœ è´¨é‡å¦‚ä½•",
        "a": "è®©æˆ‘åˆ†æä½ æœ€è¿‘çš„ç¡çœ è´¨é‡è¶‹åŠ¿...\n\nï¼ˆæ­£åœ¨åˆ†ææœ€è¿‘7å¤©çš„æ•°æ®ï¼‰",
        "intent": "data_query",
        "complexity": 4
    },
    {
        "q": "æˆ‘çš„èƒ½é‡æ°´å¹³",
        "a": "æ­£åœ¨è¯„ä¼°ä½ çš„èƒ½é‡æ°´å¹³...\n\nï¼ˆç»¼åˆåˆ†æç¡çœ ã€æ´»åŠ¨ã€å¿ƒç‡æ•°æ®ï¼‰",
        "intent": "data_query",
        "complexity": 4
    },

    # ===== å»ºè®®è¯·æ±‚ç±» (30æ¡) =====
    {
        "q": "å¦‚ä½•æ”¹å–„ç¡çœ ",
        "a": "æ”¹å–„ç¡çœ å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š\n\nğŸŒ™ **ä½œæ¯è§„å¾‹**\nâ€¢ æ¯å¤©åŒä¸€æ—¶é—´ç¡è§‰å’Œèµ·åºŠ\nâ€¢ åŒ…æ‹¬å‘¨æœ«ä¹Ÿè¦ä¿æŒè§„å¾‹\n\nğŸ“± **ç¡å‰å‡†å¤‡**\nâ€¢ ç¡å‰1å°æ—¶é¿å…è“å…‰ï¼ˆæ‰‹æœºã€ç”µè„‘ï¼‰\nâ€¢ åšä¸€äº›æ”¾æ¾æ´»åŠ¨ï¼ˆé˜…è¯»ã€å†¥æƒ³ï¼‰\n\nğŸ›ï¸ **ç¡çœ ç¯å¢ƒ**\nâ€¢ ä¿æŒæˆ¿é—´å‡‰çˆ½ï¼ˆ18-22Â°Cï¼‰\nâ€¢ ç¡®ä¿é»‘æš—å’Œå®‰é™\nâ€¢ èˆ’é€‚çš„åºŠå“\n\nâ˜• **é¥®é£Ÿæ³¨æ„**\nâ€¢ ä¸‹åˆ3ç‚¹åé¿å…å’–å•¡å› \nâ€¢ ç¡å‰2-3å°æ—¶ä¸è¦å¤§é‡è¿›é£Ÿ\n\néœ€è¦æ›´å…·ä½“çš„ä¸ªæ€§åŒ–å»ºè®®å—ï¼Ÿæˆ‘å¯ä»¥æ ¹æ®ä½ çš„æ•°æ®ç»™å‡ºé’ˆå¯¹æ€§æ–¹æ¡ˆã€‚",
        "intent": "advice_request",
        "complexity": 5
    },
    {
        "q": "å¦‚ä½•æé«˜èƒ½é‡",
        "a": "æå‡èƒ½é‡æ°´å¹³çš„æ–¹æ³•ï¼š\n\nâš¡ **ä¼˜è´¨ç¡çœ **\nâ€¢ ä¿è¯7-8å°æ—¶ç¡çœ \nâ€¢ ç¡çœ è´¨é‡æ¯”æ—¶é•¿æ›´é‡è¦\n\nğŸƒ **è§„å¾‹è¿åŠ¨**\nâ€¢ æ¯å¤©30åˆ†é’Ÿä¸­ç­‰å¼ºåº¦è¿åŠ¨\nâ€¢ è¿åŠ¨èƒ½æå‡æ•´ä½“èƒ½é‡æ°´å¹³\n\nğŸ¥— **å¥åº·é¥®é£Ÿ**\nâ€¢ å¤šåƒå…¨è°·ç‰©ã€è”¬æœ\nâ€¢ å°‘åƒåŠ å·¥é£Ÿå“å’Œç³–\nâ€¢ ä¿æŒæ°´åˆ†å……è¶³\n\nâ° **èƒ½é‡ç®¡ç†**\nâ€¢ è¯†åˆ«ä½ çš„èƒ½é‡é«˜å³°æœŸ\nâ€¢ åœ¨é«˜å³°æœŸå¤„ç†é‡è¦ä»»åŠ¡\nâ€¢ é€‚æ—¶ä¼‘æ¯å……ç”µ\n\néœ€è¦æˆ‘åˆ†æä½ çš„æ•°æ®ï¼Œåˆ¶å®šä¸ªæ€§åŒ–èƒ½é‡æå‡æ–¹æ¡ˆå—ï¼Ÿ",
        "intent": "advice_request",
        "complexity": 5
    },
    {
        "q": "å¦‚ä½•å‡å‹",
        "a": "å‡å‹çš„æœ‰æ•ˆæ–¹æ³•ï¼š\n\nğŸ§˜ **æ­£å¿µå†¥æƒ³**\nâ€¢ æ¯å¤©10-15åˆ†é’Ÿå†¥æƒ³\nâ€¢ ä¸“æ³¨å‘¼å¸ï¼Œæ”¾æ¾èº«å¿ƒ\n\nğŸš¶ **é€‚åº¦è¿åŠ¨**\nâ€¢ æ•£æ­¥ã€ç‘œä¼½ã€æ…¢è·‘\nâ€¢ è¿åŠ¨èƒ½é‡Šæ”¾å†…å•¡è‚½\n\nğŸµ **æ”¾æ¾æ´»åŠ¨**\nâ€¢ å¬éŸ³ä¹\nâ€¢ é˜…è¯»\nâ€¢ ä¸æœ‹å‹äº¤æµ\n\nğŸ’¤ **å……è¶³ç¡çœ **\nâ€¢ ç¡çœ ä¸è¶³ä¼šå¢åŠ å‹åŠ›\nâ€¢ ä¿è¯è§„å¾‹ä½œæ¯\n\nâœï¸ **æƒ…ç»ªæ—¥è®°**\nâ€¢ å†™ä¸‹å‹åŠ›æ¥æº\nâ€¢ è®°å½•åº”å¯¹ç­–ç•¥\n\néœ€è¦æˆ‘å¸®ä½ åˆ¶å®šå‡å‹è®¡åˆ’å—ï¼Ÿ",
        "intent": "advice_request",
        "complexity": 5
    },
    {
        "q": "å¦‚ä½•å¿«é€Ÿå…¥ç¡",
        "a": "å¿«é€Ÿå…¥ç¡çš„æŠ€å·§ï¼š\n\nğŸŒ¡ï¸ **4-7-8å‘¼å¸æ³•**\n1. ç”¨é¼»å­å¸æ°”4ç§’\n2. å±ä½å‘¼å¸7ç§’\n3. ç”¨å˜´å‘¼æ°”8ç§’\n4. é‡å¤3-4æ¬¡\n\nğŸ§  **è®¤çŸ¥æ–¹æ³•**\nâ€¢ æ•°ç¾Šæˆ–å€’æ•°\nâ€¢ æƒ³è±¡å¹³é™çš„åœºæ™¯\nâ€¢ èº«ä½“æ‰«ææ”¾æ¾æ³•\n\nğŸ›ï¸ **ç¯å¢ƒä¼˜åŒ–**\nâ€¢ é™ä½æ¸©åº¦åˆ°18-20Â°C\nâ€¢ å®Œå…¨é»‘æš—\nâ€¢ ç™½å™ªéŸ³æˆ–è‡ªç„¶å£°\n\nğŸ“µ **ç¡å‰ä¹ æƒ¯**\nâ€¢ å…³é—­æ‰€æœ‰å±å¹•\nâ€¢ é˜…è¯»çº¸è´¨ä¹¦\nâ€¢ æ¸©æ°´æ³¡è„š\n\nå¦‚æœé•¿æœŸå¤±çœ ï¼Œå»ºè®®å’¨è¯¢åŒ»ç”Ÿã€‚éœ€è¦æˆ‘æ ¹æ®ä½ çš„æ•°æ®ç»™å‡ºæ›´å…·ä½“å»ºè®®å—ï¼Ÿ",
        "intent": "advice_request",
        "complexity": 5
    },
    {
        "q": "å¦‚ä½•ä¿æŒä¸“æ³¨",
        "a": "æå‡ä¸“æ³¨åŠ›çš„æ–¹æ³•ï¼š\n\nâ±ï¸ **ç•ªèŒ„å·¥ä½œæ³•**\nâ€¢ ä¸“æ³¨å·¥ä½œ25åˆ†é’Ÿ\nâ€¢ ä¼‘æ¯5åˆ†é’Ÿ\nâ€¢ 4ä¸ªç•ªèŒ„åä¼‘æ¯15-30åˆ†é’Ÿ\n\nğŸ¯ **å•ä»»åŠ¡æ¨¡å¼**\nâ€¢ ä¸€æ¬¡åªåšä¸€ä»¶äº‹\nâ€¢ å…³é—­é€šçŸ¥å’Œå¹²æ‰°\n\nğŸ§  **ä¼˜åŒ–å¤§è„‘çŠ¶æ€**\nâ€¢ å……è¶³ç¡çœ ï¼ˆ7-8å°æ—¶ï¼‰\nâ€¢ è§„å¾‹è¿åŠ¨\nâ€¢ å¥åº·é¥®é£Ÿ\n\nâ˜• **ç­–ç•¥æ€§ä¼‘æ¯**\nâ€¢ æ¯90åˆ†é’Ÿä¼‘æ¯ä¸€æ¬¡\nâ€¢ çŸ­æš‚èµ°åŠ¨æˆ–ä¼¸å±•\n\nğŸ“± **æ•°å­—æ’æ¯’**\nâ€¢ å›ºå®šæ—¶é—´æŸ¥çœ‹æ‰‹æœº\nâ€¢ ä½¿ç”¨ä¸“æ³¨ç±»APP\n\néœ€è¦å¸®ä½ åˆ¶å®šä¸“æ³¨åŠ›æå‡è®¡åˆ’å—ï¼Ÿ",
        "intent": "advice_request",
        "complexity": 5
    },

    # ===== æƒ…æ„Ÿæ”¯æŒç±» (15æ¡) =====
    {
        "q": "æˆ‘å¾ˆç„¦è™‘",
        "a": "æˆ‘ç†è§£ä½ ç°åœ¨çš„æ„Ÿå—ï¼Œç„¦è™‘ç¡®å®å¾ˆéš¾å—ã€‚ğŸ’™\n\né¦–å…ˆï¼Œæ·±å‘¼å¸å‡ æ¬¡ï¼Œè®©è‡ªå·±å¹³é™ä¸‹æ¥ã€‚\n\n**ä¸€äº›å¯ä»¥å°è¯•çš„æ–¹æ³•ï¼š**\n\nğŸ«‚ **æ¥çº³æƒ…ç»ª**\nâ€¢ ç„¦è™‘æ˜¯æ­£å¸¸çš„æƒ…ç»ª\nâ€¢ ä¸è¦è´£å¤‡è‡ªå·±\n\nğŸ§˜ **ç«‹å³ç¼“è§£**\nâ€¢ æ·±å‘¼å¸5æ¬¡ï¼ˆ4ç§’å¸-7ç§’å±æ¯-8ç§’å‘¼ï¼‰\nâ€¢ æ‰¾ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹åä¸‹\nâ€¢ æè¿°å‘¨å›´5ä¸ªå¯è§ç‰©ä½“ï¼ˆè½¬ç§»æ³¨æ„åŠ›ï¼‰\n\nğŸ’­ **é•¿æœŸåº”å¯¹**\nâ€¢ è¯†åˆ«ç„¦è™‘æ¥æº\nâ€¢ å†™ä¸‹æ‹…å¿ƒçš„äº‹æƒ…\nâ€¢ ä¸ä¿¡ä»»çš„äººäº¤æµ\n\nå¦‚æœç„¦è™‘æŒç»­ä¸”ä¸¥é‡å½±å“ç”Ÿæ´»ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢ã€‚\n\næˆ‘åœ¨è¿™é‡Œé™ªä½ ï¼Œæœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ",
        "intent": "emotional_support",
        "complexity": 6
    },
    {
        "q": "å‹åŠ›å¾ˆå¤§",
        "a": "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ çš„å‹åŠ›ã€‚ğŸ’™ è®©æˆ‘ä»¬ä¸€èµ·æ¥åº”å¯¹ã€‚\n\n**ç«‹å³ç¼“è§£å‹åŠ›ï¼š**\n\nğŸŒŠ **5åˆ†é’Ÿæ”¾æ¾**\n1. æ‰¾ä¸€ä¸ªå®‰é™çš„åœ°æ–¹\n2. é—­ä¸Šçœ¼ç›æ·±å‘¼å¸\n3. æƒ³è±¡å‹åŠ›éšå‘¼æ°”ç¦»å¼€èº«ä½“\n\nâœï¸ **å‹åŠ›æ¸…å•**\nâ€¢ å†™ä¸‹æ‰€æœ‰å‹åŠ›æ¥æº\nâ€¢ åˆ†ç±»ï¼šå¯æ§ vs ä¸å¯æ§\nâ€¢ ä¸“æ³¨äºå¯æ§çš„éƒ¨åˆ†\n\nğŸ¯ **åˆ†è§£ä»»åŠ¡**\nâ€¢ å°†å¤§ä»»åŠ¡æ‹†åˆ†æˆå°æ­¥éª¤\nâ€¢ æ¯å®Œæˆä¸€æ­¥å°±å¥–åŠ±è‡ªå·±\n\nğŸ¤ **å¯»æ±‚æ”¯æŒ**\nâ€¢ ä¸æœ‹å‹æˆ–å®¶äººäº¤æµ\nâ€¢ å¿…è¦æ—¶å¯»æ±‚ä¸“ä¸šå¸®åŠ©\n\nè®°ä½ï¼Œä½ ä¸æ˜¯ä¸€ä¸ªäººåœ¨æˆ˜æ–—ã€‚æƒ³èŠèŠå‹åŠ›çš„å…·ä½“æ¥æºå—ï¼Ÿ",
        "intent": "emotional_support",
        "complexity": 6
    },
    {
        "q": "æˆ‘å¾ˆç´¯",
        "a": "å¬èµ·æ¥ä½ ç¡®å®éœ€è¦å¥½å¥½ä¼‘æ¯äº†ã€‚ğŸ’™\n\n**ç«‹å³è¡ŒåŠ¨ï¼š**\n\nğŸ˜´ **å¦‚æœå¯èƒ½ï¼Œä¼‘æ¯ä¸€ä¸‹**\nâ€¢ å°ç¡15-20åˆ†é’Ÿ\nâ€¢ æˆ–è€…ç®€å•åœ°é—­ç›®å…»ç¥\n\nğŸ’§ **è¡¥å……èƒ½é‡**\nâ€¢ å–ä¸€æ¯æ°´ï¼ˆè„±æ°´ä¼šå¯¼è‡´ç–²åŠ³ï¼‰\nâ€¢ åƒç‚¹å¥åº·é›¶é£Ÿï¼ˆåšæœã€æ°´æœï¼‰\n\nğŸš¶ **è½»åº¦æ´»åŠ¨**\nâ€¢ çŸ­æš‚æ•£æ­¥5-10åˆ†é’Ÿ\nâ€¢ ç®€å•ä¼¸å±•è¿åŠ¨\n\n**é•¿æœŸæ”¹å–„ï¼š**\nâ€¢ æ£€æŸ¥ç¡çœ è´¨é‡\nâ€¢ è§„å¾‹ä½œæ¯\nâ€¢ é€‚åº¦è¿åŠ¨\n\néœ€è¦æˆ‘åˆ†æä½ çš„ç¡çœ æ•°æ®ï¼Œæ‰¾å‡ºç–²åŠ³åŸå› å—ï¼Ÿ",
        "intent": "emotional_support",
        "complexity": 6
    },
    {
        "q": "å¿ƒæƒ…ä¸å¥½",
        "a": "æˆ‘å¾ˆæŠ±æ­‰ä½ ç°åœ¨å¿ƒæƒ…ä¸å¥½ã€‚ğŸ’™ æˆ‘åœ¨è¿™é‡Œé™ªä½ ã€‚\n\n**ä¸€äº›å¯èƒ½æœ‰å¸®åŠ©çš„äº‹æƒ…ï¼š**\n\nğŸµ **è½¬ç§»æ³¨æ„åŠ›**\nâ€¢ å¬å–œæ¬¢çš„éŸ³ä¹\nâ€¢ çœ‹æç¬‘è§†é¢‘\nâ€¢ åšå–œæ¬¢çš„æ´»åŠ¨\n\nğŸŒ **æ”¹å˜ç¯å¢ƒ**\nâ€¢ å‡ºå»èµ°èµ°ï¼Œæ™’æ™’å¤ªé˜³\nâ€¢ æ¢ä¸ªç¯å¢ƒ\nâ€¢ æ¥è§¦å¤§è‡ªç„¶\n\nğŸ¤— **ç¤¾äº¤è¿æ¥**\nâ€¢ ä¸æœ‹å‹èŠå¤©\nâ€¢ æ‹¥æŠ±å® ç‰©æˆ–äº²äºº\n\nâœï¸ **æƒ…ç»ªæ—¥è®°**\nâ€¢ å†™ä¸‹æ„Ÿå—\nâ€¢ ä¸è¯„åˆ¤ï¼Œåªè®°å½•\n\nè®°ä½ï¼Œæƒ…ç»ªèµ·ä¼æ˜¯æ­£å¸¸çš„ã€‚å¦‚æœæŒç»­ä½è½è¶…è¿‡ä¸¤å‘¨ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©ã€‚\n\næƒ³èŠèŠå‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿ",
        "intent": "emotional_support",
        "complexity": 6
    },

    # ===== å¥åº·çŸ¥è¯†ç±» (25æ¡) =====
    {
        "q": "ä»€ä¹ˆæ˜¯æ·±åº¦ç¡çœ ",
        "a": "æ·±åº¦ç¡çœ æ˜¯ç¡çœ æœ€é‡è¦çš„é˜¶æ®µä¹‹ä¸€ï¼š\n\nğŸ§  **å®šä¹‰**\nâ€¢ éå¿«é€Ÿçœ¼åŠ¨ç¡çœ ï¼ˆNREMï¼‰ç¬¬3-4é˜¶æ®µ\nâ€¢ å¤§è„‘æ´»åŠ¨æœ€æ…¢ï¼Œæœ€éš¾è¢«å”¤é†’çš„é˜¶æ®µ\n\nâš¡ **ä½œç”¨**\nâ€¢ èº«ä½“ä¿®å¤å’Œç”Ÿé•¿\nâ€¢ å¢å¼ºå…ç–«ç³»ç»Ÿ\nâ€¢ å·©å›ºè®°å¿†\nâ€¢ æ¸…é™¤å¤§è„‘ä»£è°¢åºŸç‰©\n\nâ±ï¸ **æ—¶é•¿**\nâ€¢ æˆå¹´äººï¼šæ€»ç¡çœ çš„15-25%\nâ€¢ 7-8å°æ—¶ç¡çœ ä¸­çº¦1-2å°æ—¶\nâ€¢ ä¸»è¦é›†ä¸­åœ¨å‰åŠå¤œ\n\nğŸ“ˆ **å¦‚ä½•å¢åŠ **\nâ€¢ è§„å¾‹ä½œæ¯\nâ€¢ é¿å…ç¡å‰é¥®é…’\nâ€¢ ä¿æŒé€‚åº¦è¿åŠ¨\nâ€¢ ç¡å‰æ”¾æ¾\n\néœ€è¦æˆ‘åˆ†æä½ çš„æ·±åº¦ç¡çœ æ•°æ®å—ï¼Ÿ",
        "intent": "advice_request",
        "complexity": 5
    },
    {
        "q": "ä»€ä¹ˆæ˜¯REMç¡çœ ",
        "a": "REMç¡çœ ï¼ˆå¿«é€Ÿçœ¼åŠ¨ç¡çœ ï¼‰ï¼š\n\nğŸ‘ï¸ **ç‰¹å¾**\nâ€¢ çœ¼çƒå¿«é€Ÿè¿åŠ¨\nâ€¢ å¤§è„‘æ´»è·ƒï¼Œç±»ä¼¼æ¸…é†’çŠ¶æ€\nâ€¢ èº«ä½“è‚Œè‚‰å®Œå…¨æ”¾æ¾ï¼ˆç¡çœ éº»ç—¹ï¼‰\nâ€¢ å¤§éƒ¨åˆ†æ¢¦å¢ƒå‘ç”Ÿåœ¨æ­¤é˜¶æ®µ\n\nğŸ§  **åŠŸèƒ½**\nâ€¢ å¤„ç†æƒ…ç»ª\nâ€¢ å·©å›ºå­¦ä¹ å’Œè®°å¿†\nâ€¢ ä¿ƒè¿›åˆ›é€ åŠ›\nâ€¢ å¤§è„‘æ’æ¯’\n\nâ±ï¸ **æ—¶é•¿**\nâ€¢ å æ€»ç¡çœ çš„20-25%\nâ€¢ 7-8å°æ—¶ç¡çœ ä¸­çº¦1.5-2å°æ—¶\nâ€¢ ä¸»è¦é›†ä¸­åœ¨ååŠå¤œ\n\nğŸ“Š **REM vs æ·±åº¦ç¡çœ **\nâ€¢ æ·±åº¦ç¡çœ ï¼šèº«ä½“ä¿®å¤\nâ€¢ REMç¡çœ ï¼šå¤§è„‘æ•´ç†\nâ€¢ ä¸¤è€…éƒ½å¾ˆé‡è¦ï¼\n\næƒ³çœ‹çœ‹ä½ çš„REMç¡çœ æ•°æ®å—ï¼Ÿ",
        "intent": "advice_request",
        "complexity": 5
    },
    {
        "q": "ä»€ä¹ˆæ˜¯å¿ƒç‡å˜å¼‚æ€§",
        "a": "å¿ƒç‡å˜å¼‚æ€§ï¼ˆHRVï¼‰æ˜¯é‡è¦çš„å¥åº·æŒ‡æ ‡ï¼š\n\nğŸ’“ **å®šä¹‰**\nâ€¢ å¿ƒè·³é—´éš”çš„å˜åŒ–ç¨‹åº¦\nâ€¢ ä¸æ˜¯å¿ƒç‡å¿«æ…¢ï¼Œè€Œæ˜¯èŠ‚å¥çš„å˜åŒ–\n\nğŸ§  **æ„ä¹‰**\nâ€¢ åæ˜ è‡ªå¾‹ç¥ç»ç³»ç»ŸåŠŸèƒ½\nâ€¢ HRVé«˜ï¼šèº«ä½“é€‚åº”åŠ›å¼ºï¼Œå‹åŠ›åº”å¯¹å¥½\nâ€¢ HRVä½ï¼šå¯èƒ½ç–²åŠ³ã€å‹åŠ›å¤§ã€æ¢å¤ä¸è¶³\n\nğŸ“Š **æ­£å¸¸èŒƒå›´**\nâ€¢ å› äººè€Œå¼‚ï¼Œæ²¡æœ‰ç»å¯¹æ ‡å‡†\nâ€¢ é‡è¦çš„æ˜¯ä¸ªäººåŸºçº¿å’Œè¶‹åŠ¿\n\nğŸ“ˆ **å¦‚ä½•æé«˜HRV**\nâ€¢ å……è¶³ä¼˜è´¨ç¡çœ \nâ€¢ è§„å¾‹è¿åŠ¨ï¼ˆä¸è¿‡åº¦ï¼‰\nâ€¢ å‹åŠ›ç®¡ç†ï¼ˆå†¥æƒ³ã€å‘¼å¸ç»ƒä¹ ï¼‰\nâ€¢ é¿å…é…—é…’å’Œå¸çƒŸ\n\néœ€è¦æˆ‘åˆ†æä½ çš„HRVæ•°æ®å—ï¼Ÿ",
        "intent": "advice_request",
        "complexity": 5
    },

    # ç»§ç»­æ·»åŠ æ›´å¤šé—®é¢˜... (æ€»å…±ç›®æ ‡100+æ¡)
]


async def generate_knowledge_base():
    """
    ç”ŸæˆçŸ¥è¯†åº“

    å°†æ‰€æœ‰é¢„å®šä¹‰çš„é—®ç­”å¯¹ç¼–ç å¹¶å­˜å…¥Qdrant
    """
    logger.info("ğŸš€ Starting knowledge base generation...")

    try:
        # å¯¼å…¥ä¾èµ–
        from app.ai.response_cache import get_response_cache_manager
        from app.ai.response_cache import CacheEntry
        import hashlib
        from datetime import datetime

        # åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
        cache_manager = await get_response_cache_manager()
        await cache_manager.initialize()

        logger.info(f"ğŸ“š Processing {len(KNOWLEDGE_BASE)} knowledge base entries...")

        success_count = 0
        error_count = 0

        for idx, qa in enumerate(KNOWLEDGE_BASE, 1):
            try:
                # åˆ›å»ºç¼“å­˜æ¡ç›®
                cache_entry = CacheEntry(
                    query=qa["q"],
                    response=qa["a"],
                    provider="knowledge_base",
                    intent=qa.get("intent", "general"),
                    complexity=qa.get("complexity", 1),
                    tokens_used=0,  # çŸ¥è¯†åº“ç­”æ¡ˆæ— tokenæˆæœ¬
                    cached_at=datetime.utcnow().isoformat(),
                    hit_count=0,
                    user_id="system"
                )

                # ç¼–ç æŸ¥è¯¢å‘é‡
                import asyncio
                loop = asyncio.get_event_loop()
                query_vector = await loop.run_in_executor(
                    None,
                    lambda: cache_manager.sentence_transformer.encode(
                        qa["q"],
                        convert_to_tensor=False
                    ).tolist()
                )

                # ç”Ÿæˆç‚¹ID
                point_id = hashlib.md5(qa["q"].encode()).hexdigest()

                # æ’å…¥åˆ°knowledge_base_qa collection
                from qdrant_client.models import PointStruct

                cache_manager.qdrant_client.upsert(
                    collection_name="knowledge_base_qa",
                    points=[
                        PointStruct(
                            id=point_id,
                            vector=query_vector,
                            payload=cache_entry.to_dict()
                        )
                    ]
                )

                success_count += 1

                if idx % 10 == 0:
                    logger.info(f"Progress: {idx}/{len(KNOWLEDGE_BASE)} entries processed")

            except Exception as e:
                error_count += 1
                logger.error(f"Failed to process entry {idx}: {qa['q'][:30]}... | Error: {e}")

        # ç»Ÿè®¡ç»“æœ
        logger.info("=" * 80)
        logger.info("âœ… Knowledge base generation completed!")
        logger.info(f"Total entries: {len(KNOWLEDGE_BASE)}")
        logger.info(f"Success: {success_count}")
        logger.info(f"Errors: {error_count}")
        logger.info(f"Success rate: {success_count/len(KNOWLEDGE_BASE)*100:.1f}%")
        logger.info("=" * 80)

        return success_count, error_count

    except Exception as e:
        logger.error(f"âŒ Knowledge base generation failed: {e}")
        raise


async def verify_knowledge_base():
    """
    éªŒè¯çŸ¥è¯†åº“

    æµ‹è¯•å‡ ä¸ªæŸ¥è¯¢ï¼Œç¡®è®¤çŸ¥è¯†åº“æ­£å¸¸å·¥ä½œ
    """
    logger.info("ğŸ” Verifying knowledge base...")

    from app.ai.response_cache import get_response_cache_manager

    cache_manager = await get_response_cache_manager()
    await cache_manager.initialize()

    # æµ‹è¯•æŸ¥è¯¢
    test_queries = [
        "ä½ å¥½",
        "å¦‚ä½•æ”¹å–„ç¡çœ ",
        "æˆ‘å¾ˆç„¦è™‘",
        "ä»€ä¹ˆæ˜¯æ·±åº¦ç¡çœ "
    ]

    logger.info(f"Testing {len(test_queries)} queries...")

    for query in test_queries:
        result = await cache_manager._check_l3_cache(query)

        if result:
            logger.info(f"âœ… '{query}' -> Found answer (score>0.88)")
        else:
            logger.warning(f"âŒ '{query}' -> No answer found")

    logger.info("Verification completed!")


if __name__ == "__main__":
    import sys

    # å‘½ä»¤è¡Œå‚æ•°
    if len(sys.argv) > 1 and sys.argv[1] == "--verify":
        # ä»…éªŒè¯
        asyncio.run(verify_knowledge_base())
    else:
        # ç”ŸæˆçŸ¥è¯†åº“
        asyncio.run(generate_knowledge_base())

        # è‡ªåŠ¨éªŒè¯
        print("\n")
        asyncio.run(verify_knowledge_base())
